{% extends "base.html" %}

{% block title %}–ì–æ–ª–æ–≤–Ω–∞ - –ê–Ω–∞–ª—ñ–∑ –∫–ª—ñ—î–Ω—Ç—ñ–≤{% endblock %}

{% block extra_css %}
<style>
/* –°—Ç–∏–ª—ñ –¥–ª—è —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ—ó –≤–∏—Å–æ—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –±–µ–∑ —Å–∫—Ä–æ–ª—É */
html, body {
    height: 100%;
    overflow: hidden;
}

.main-container {
    height: calc(100vh - 56px); /* –í—Ä–∞—Ö–æ–≤—É—î–º–æ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—é */
    display: flex;
    flex-direction: column;
    padding: 8px;
    overflow: hidden;
}

/* –ö–æ–º–ø–∞–∫—Ç–Ω—ñ —Å—Ç–∏–ª—ñ */
.page-header {
    margin-bottom: 8px;
    flex-shrink: 0;
}

.page-header h1 {
    font-size: 1.5rem;
    margin-bottom: 4px;
}

.stats-section {
    margin-bottom: 8px;
    flex-shrink: 0;
}

.stats-section .row {
    display: flex;
    align-items: stretch;
}

.stats-section .card {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.stats-section .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
}


.card-header {
    padding: 3px 5px;
    font-size: 0.85rem;
}

.card-body {
    padding: 3px 5px;
}

.card-title {
    font-size: 1.2rem;
    margin-bottom: 2px;
}

.card-text {
    font-size: 0.8rem;
    margin-bottom: 0;
}

/* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω—ñ —Å–µ–∫—Ü—ñ—ó */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 5px;
    margin-bottom: 8px;
    align-items: stretch;
}

.stat-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 3px 5px;
    text-align: left;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.stat-card h6 {
    font-size: 0.75rem;
    margin-bottom: 2px;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
}

.stat-value {
    font-size: 1.1rem;
    font-weight: bold;
    color: #495057;
    margin-bottom: 2px;
}

.stat-label {
    font-size: 0.7rem;
    color: #6c757d;
    margin-bottom: 2px;
}

/* –°–µ–∫—Ü—ñ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
.stats-section {
    margin-bottom: 8px;
}

.stats-section-detailed {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
    overflow: hidden;
}

.stats-section-detailed > div {
    background: #fafbfc;
    border: 1px solid #e8e9ea;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
}

.stats-section h4, .stats-section-detailed h4 {
    font-size: 1rem;
    margin-bottom: 8px;
    color: #495057;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 2px;
}

/* –†–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –±–ª–æ–∫—ñ–≤ */
.period-info {
    font-size: 0.65rem;
    color: #6c757d;
    margin-bottom: 4px;
    font-style: italic;
}

.card {
    margin-bottom: 8px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    border: 1px solid #e8e9ea !important;
}

.card:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    transition: box-shadow 0.2s ease;
}

/* –ö–∞—Ä—É—Å–µ–ª—å –¥–ª—è —Å—É–¥—ñ–≤ */
.courts-carousel {
    position: relative;
    overflow: hidden;
}

.courts-carousel-container {
    display: flex;
    transition: transform 0.3s ease;
    width: 100%;
}

.courts-carousel-page {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 5px;
    width: 100%;
    flex-shrink: 0;
}

.carousel-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 10px;
    gap: 10px;
}

.carousel-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 5px 10px;
    font-size: 0.8rem;
    cursor: pointer;
    border-radius: 4px;
}

.carousel-btn:hover {
    background: #e9ecef;
}

.carousel-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.carousel-info {
    font-size: 0.8rem;
    color: #6c757d;
}
</style>
{% endblock %}

{% block main_content %}
<div class="main-container">
    <!-- –ö–æ–º–ø–∞–∫—Ç–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="page-header">
        <h1>–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª—ñ–∑—É —Å–ø—Ä–∞–≤ –ø—Ä–æ –±–∞–Ω–∫—Ä—É—Ç—Å—Ç–≤–æ</h1>
    </div>

    <!-- –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div>
        <h4>üìä –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
        <div class="stats-grid">
            <div class="stat-card">
                <h6>–ó–∞ –≤–µ—Å—å –ø–µ—Ä—ñ–æ–¥ (–∑ {{ date_range.min_date|date:"d.m.Y" }} –ø–æ {{ date_range.max_date|date:"d.m.Y" }})</h6>
                <div class="stat-label"><span class="stat-value">{{ total_cases }}</span> –∑–∞–ø–∏—Å—ñ–≤, –∑ —è–∫–∏—Ö:</div>
                <div style="font-size: 0.6em; text-align: left; line-height: 1.2; margin-top: 2px;">
                    {% for type_stat in total_case_types_stats %}
                        <div style="margin-bottom: 1px;">{{ type_stat.type }} - {{ type_stat.count }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="stat-card">
                <h6>–ü–æ—Ç–æ—á–Ω–∏–π —Ä—ñ–∫ ({{ current_year }})</h6>
                <div class="stat-label"><span class="stat-value">{{ current_year_cases }}</span> –∑–∞–ø–∏—Å—ñ–≤, –∑ —è–∫–∏—Ö:</div>
                <div style="font-size: 0.6em; text-align: left; line-height: 1.2; margin-top: 2px;">
                    {% for type_stat in current_year_case_types %}
                        <div style="margin-bottom: 1px;">{{ type_stat.type }} - {{ type_stat.count }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="stat-card">
                <h6>–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ä—ñ–∫ ({{ current_year|add:"-1" }})</h6>
                <div class="stat-label"><span class="stat-value">{{ prev_year_cases }}</span> –∑–∞–ø–∏—Å—ñ–≤, –∑ —è–∫–∏—Ö:</div>
                <div style="font-size: 0.6em; text-align: left; line-height: 1.2; margin-top: 2px;">
                    {% for type_stat in prev_year_case_types %}
                        <div style="margin-bottom: 1px;">{{ type_stat.type }} - {{ type_stat.count }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="stat-card">
                <h6>–ó–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 30 –¥–Ω—ñ–≤</h6>
                <div class="stat-label"><span class="stat-value">{{ recent_cases_count }}</span> –∑–∞–ø–∏—Å—ñ–≤, –∑ —è–∫–∏—Ö:</div>
                <div style="font-size: 0.6em; text-align: left; line-height: 1.2; margin-top: 2px;">
                    {% for type_stat in recent_case_types %}
                        <div style="margin-bottom: 1px;">{{ type_stat.type }} - {{ type_stat.count }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ -->
    <div class="stats-section">
        <div class="row">
            <div class="col-md-12">
                <div class="card border-info">
                    <div class="card-body">
                        <h4>üîç –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –ø–æ—à—É–∫—É —Å—É–¥–æ–≤–∏—Ö —Ä—ñ—à–µ–Ω—å</h4>
                        <div id="monitoring-stats" class="stats-grid">
                            <div class="stat-card">
                                <h6>–°–ø—Ä–∞–≤–∏ –±–µ–∑ —Ä—ñ—à–µ–Ω—å</h6>
                                <div class="stat-label">
                                    <span id="cases-without-decisions" class="stat-value">-</span> –∑ 
                                    <span id="total-cases" class="stat-value">-</span>
                                </div>
                                <div class="progress" style="height: 6px; margin-top: 4px;">
                                    <div id="cases-progress" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <h6>–°—É–¥–æ–≤—ñ —Ä—ñ—à–µ–Ω–Ω—è</h6>
                                <div class="stat-label">
                                    <span id="total-decisions" class="stat-value">-</span> –∑–Ω–∞–π–¥–µ–Ω–æ
                                </div>
                                <div style="font-size: 0.7em; line-height: 1.3; margin-top: 2px;">
                                    <div class="text-success">‚úÖ <span id="decisions-with-resolutions" class="stat-value">-</span> –∑ —Ä–µ–∑–æ–ª—é—Ç–∏–≤–Ω–∏–º–∏ —á–∞—Å—Ç–∏–Ω–∞–º–∏</div>
                                    <div class="text-warning">‚ö†Ô∏è <span id="decisions-without-resolutions" class="stat-value">-</span> –±–µ–∑ —Ä–µ–∑–æ–ª—é—Ç–∏–≤–Ω–∏—Ö —á–∞—Å—Ç–∏–Ω</div>
                                    <div class="text-danger">‚ùå <span id="decisions-without-rtf" class="stat-value">-</span> –±–µ–∑ RTF —Ñ–∞–π–ª—ñ–≤</div>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <h6>–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω</h6>
                                <div id="current-status" class="stat-label">
                                    <span class="badge badge-secondary">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è...</span>
                                </div>
                                <div id="progress-info" class="text-muted" style="font-size: 0.75em; margin-top: 2px;"></div>
                            </div>
                            
                            <div class="stat-card">
                                <h6>–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</h6>
                                <div id="last-updated" class="stat-label" style="font-size: 0.85em;">
                                    <span class="text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
                                </div>
                                <div style="font-size: 0.7em; margin-top: 2px;">
                                    <div id="last-search" class="text-muted">–ü–æ—à—É–∫: -</div>
                                    <div id="last-extraction" class="text-muted">–í–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è: -</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-section-detailed">

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 6 –º—ñ—Å—è—Ü—ñ–≤ -->
        <div>
            <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 6 –º—ñ—Å—è—Ü—ñ–≤</h4>
            <div class="stats-grid">
                {% for month_stat in last_6_months_stats %}
                <div class="stat-card">
                    <h6>{{ month_stat.month }} {{ month_stat.year }}</h6>
                    <div class="stat-label"><span class="stat-value">{{ month_stat.count }}</span> –∑–∞–ø–∏—Å—ñ–≤, –∑ —è–∫–∏—Ö:</div>
                    {% if month_stat.count > 0 %}
                    <div style="font-size: 0.6em; text-align: left; line-height: 1.2; margin-top: 2px;">
                        {% for type_stat in month_stat.types %}
                            <div style="margin-bottom: 1px;">{{ type_stat.type }} - {{ type_stat.count }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- –¢–æ–ø —Å—É–¥–∏ –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏ -->
        <div>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                <h4>üèõÔ∏è –¢–û–ü-5 –°—É–¥—ñ–≤ –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Å–ø—Ä–∞–≤</h4>
                <form method="GET" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <!-- –°–ø–∞–¥–Ω–µ –º–µ–Ω—é –∑–∞–≤–∂–¥–∏ –≤–∏–¥–∏–º–µ -->
                    <select name="courts_period" onchange="handlePeriodChange(this)" style="font-size: 0.8rem; padding: 2px 5px;">
                        <option value="all" {% if courts_period == "all" %}selected{% endif %}>–ó–∞ –≤–µ—Å—å –ø–µ—Ä—ñ–æ–¥</option>
                        <option value="1_year" {% if courts_period == "1_year" %}selected{% endif %}>–ó–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä—ñ–∫</option>
                        <option value="2_years" {% if courts_period == "2_years" %}selected{% endif %}>–ó–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 2 —Ä–æ–∫–∏</option>
                        <option value="3_years" {% if courts_period == "3_years" %}selected{% endif %}>–ó–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 3 —Ä–æ–∫–∏</option>
                        <option value="5_years" {% if courts_period == "5_years" %}selected{% endif %}>–ó–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 5 —Ä–æ–∫—ñ–≤</option>
                        <option value="10_years" {% if courts_period == "10_years" %}selected{% endif %}>–ó–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 10 —Ä–æ–∫—ñ–≤</option>
                        <option value="15_years" {% if courts_period == "15_years" %}selected{% endif %}>–ó–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 15 —Ä–æ–∫—ñ–≤</option>
                        <option value="20_years" {% if courts_period == "20_years" %}selected{% endif %}>–ó–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 20 —Ä–æ–∫—ñ–≤</option>
                        <option value="custom" {% if courts_period == "custom" %}selected{% endif %}>–ó–∞ –ø–µ—Ä—ñ–æ–¥</option>
                    </select>
                    
                    <!-- –ü–æ–ª—è –≤–∏–±–æ—Ä—É –ø–µ—Ä—ñ–æ–¥—É –∑–∞–≤–∂–¥–∏ –≤–∏–¥–∏–º—ñ -->
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <label style="font-size: 0.75rem; color: #6c757d;">–ó:</label>
                        <input type="date" name="courts_date_from" value="{% if courts_date_from and courts_date_from != 'None' %}{{ courts_date_from }}{% endif %}" style="font-size: 0.8rem; padding: 2px 5px;">
                        <label style="font-size: 0.75rem; color: #6c757d;">–ü–æ:</label>
                        <input type="date" name="courts_date_to" value="{% if courts_date_to and courts_date_to != 'None' %}{{ courts_date_to }}{% endif %}" style="font-size: 0.8rem; padding: 2px 5px;">
                        <button type="submit" style="font-size: 0.8rem; padding: 2px 8px;">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
                    </div>
                </form>
            </div>
            
            <!-- –ö–∞—Ä—É—Å–µ–ª—å —Å—É–¥—ñ–≤ -->
            <div class="courts-carousel" id="courtsCarousel">
                <div class="courts-carousel-container" id="courtsContainer">
                    <!-- –°—Ç–æ—Ä—ñ–Ω–∫–∏ –∫–∞—Ä—É—Å–µ–ª—ñ –±—É–¥—É—Ç—å –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏—Å—è JavaScript -->
                </div>
            </div>
            
            <!-- –ï–ª–µ–º–µ–Ω—Ç–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–∞—Ä—É—Å–µ–ª–ª—é -->
            <div class="carousel-controls">
                <button class="carousel-btn" id="prevBtn" onclick="prevPage()">‚Üê –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ</button>
                <span class="carousel-info" id="pageInfo">–°—Ç–æ—Ä—ñ–Ω–∫–∞ 1 –∑ 1</span>
                <button class="carousel-btn" id="nextBtn" onclick="nextPage()">–ù–∞—Å—Ç—É–ø–Ω—ñ ‚Üí</button>
            </div>
        </div>

    </div>
</div>

<script>
// –î–∞–Ω—ñ —Å—É–¥—ñ–≤ –∑ —à–∞–±–ª–æ–Ω—É Django  
const courtsData = [
    {% for court_data in top_courts %}
    {
        court: {
            name: "{{ court_data.court.name|escapejs }}"
        },
        cases_count: {{ court_data.cases_count }},
        types: [
            {% for type_stat in court_data.types %}
            {
                type: "{{ type_stat.type|escapejs }}",
                count: {{ type_stat.count }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];
let currentPage = 0;
const itemsPerPage = 5; // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ 5 —Å—É–¥—ñ–≤ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
const totalPages = Math.ceil(courtsData.length / itemsPerPage);

function createCourtCard(courtData) {
    let typesHtml = "";
    if (courtData.cases_count > 0 && courtData.types) {
        courtData.types.forEach(typeStat => {
            typesHtml += `<div style="margin-bottom: 1px;">${typeStat.type} - ${typeStat.count}</div>`;
        });
    }
    
    return `
        <div class="stat-card">
            <h6>${courtData.court.name}</h6>
            <div class="stat-label"><span class="stat-value">${courtData.cases_count}</span> –∑–∞–ø–∏—Å—ñ–≤, –∑ —è–∫–∏—Ö:</div>
            ${courtData.cases_count > 0 ? `
            <div style="font-size: 0.6em; text-align: left; line-height: 1.2; margin-top: 2px;">
                ${typesHtml}
            </div>
            ` : ""}
        </div>
    `;
}

function renderCarousel() {
    const container = document.getElementById("courtsContainer");
    const pageInfo = document.getElementById("pageInfo");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    
    if (!container || courtsData.length === 0) return;
    
    // –û—á–∏—â—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    container.innerHTML = "";
    
    // –°—Ç–≤–æ—Ä—é—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    for (let page = 0; page < totalPages; page++) {
        const pageDiv = document.createElement("div");
        pageDiv.className = "courts-carousel-page";
        
        const startIndex = page * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, courtsData.length);
        
        for (let i = startIndex; i < endIndex; i++) {
            pageDiv.innerHTML += createCourtCard(courtsData[i]);
        }
        
        container.appendChild(pageDiv);
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –∫–∞—Ä—É—Å–µ–ª—ñ
    container.style.transform = `translateX(-${currentPage * 100}%)`;
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É
    pageInfo.textContent = `–°—Ç–æ—Ä—ñ–Ω–∫–∞ ${currentPage + 1} –∑ ${totalPages}`;
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫
    prevBtn.disabled = currentPage === 0;
    nextBtn.disabled = currentPage >= totalPages - 1;
}

function nextPage() {
    if (currentPage < totalPages - 1) {
        currentPage++;
        renderCarousel();
    }
}

function prevPage() {
    if (currentPage > 0) {
        currentPage--;
        renderCarousel();
    }
}

function handlePeriodChange(select) {
    // –Ø–∫—â–æ –≤–∏–±—Ä–∞–Ω–æ –Ω–µ "–ó–∞ –ø–µ—Ä—ñ–æ–¥" (custom), –≤—ñ–¥—Ä–∞–∑—É –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ñ–æ—Ä–º—É
    if (select.value !== "custom") {
        select.form.submit();
    }
    // –Ø–∫—â–æ –≤–∏–±—Ä–∞–Ω–æ "–ó–∞ –ø–µ—Ä—ñ–æ–¥", –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–ø–æ–≤–Ω—é—î –¥–∞—Ç–∏ —Ç–∞ –Ω–∞—Ç–∏—Å–∫–∞—î "–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏"
}

// –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥–æ–º
let monitoringInterval;

async function fetchMonitoringStats() {
    console.log("üîç –ü–æ—á–∞—Ç–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É...");
    try {
        const response = await fetch("/api/monitoring-stats/");
        const data = await response.json();
        console.log("üìä –û—Ç—Ä–∏–º–∞–Ω—ñ –¥–∞–Ω—ñ:", data);

        if (data.status === "success") {
            console.log("‚úÖ –£—Å–ø—ñ—à–Ω–æ –æ—Ç—Ä–∏–º–∞–Ω—ñ –¥–∞–Ω—ñ, –æ–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å...");
            updateMonitoringDisplay(data.data);
        } else {
            console.error("–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É:", data.message);
        }
    } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É:", error);
    }
}

function updateMonitoringDisplay(data) {
    console.log("üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –∑ –¥–∞–Ω–∏–º–∏:", data);

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
    const totalCasesEl = document.getElementById("total-cases");
    const casesWithoutDecisionsEl = document.getElementById("cases-without-decisions");
    const totalDecisionsEl = document.getElementById("total-decisions");

    console.log("üéØ –ó–Ω–∞–π–¥–µ–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏:", {
        totalCases: totalCasesEl ? "‚úÖ" : "‚ùå",
        casesWithoutDecisions: casesWithoutDecisionsEl ? "‚úÖ" : "‚ùå",
        totalDecisions: totalDecisionsEl ? "‚úÖ" : "‚ùå"
    });

    // –û–Ω–æ–≤–ª—é—î–º–æ –æ—Å–Ω–æ–≤–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏
    if (totalCasesEl) totalCasesEl.textContent = data.total_cases.toLocaleString();
    if (casesWithoutDecisionsEl) casesWithoutDecisionsEl.textContent = data.cases_without_decisions.toLocaleString();
    if (totalDecisionsEl) totalDecisionsEl.textContent = data.total_decisions.toLocaleString();
    document.getElementById("decisions-with-resolutions").textContent = data.decisions_with_resolutions.toLocaleString();
    document.getElementById("decisions-without-resolutions").textContent = data.decisions_without_resolutions.toLocaleString();
    document.getElementById("decisions-without-rtf").textContent = data.decisions_without_rtf.toLocaleString();
    
    // –ü—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä –¥–ª—è —Å–ø—Ä–∞–≤ –∑ —Ä—ñ—à–µ–Ω–Ω—è–º–∏
    const casesProgress = (data.cases_with_decisions / data.total_cases) * 100;
    document.getElementById("cases-progress").style.width = casesProgress.toFixed(1) + "%";
    
    // –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω
    const statusElement = document.getElementById("current-status");
    const progressInfoElement = document.getElementById("progress-info");
    
    if (data.currently_processing) {
        statusElement.innerHTML = "<span class='badge badge-primary'>üîÑ " + data.processing_type + "</span>";
        if (data.total_to_process > 0) {
            progressInfoElement.textContent = `${data.processed_count}/${data.total_to_process} (${data.progress_percentage}%)`;
        } else {
            progressInfoElement.textContent = `–û–±—Ä–æ–±–ª–µ–Ω–æ: ${data.processed_count}`;
        }
    } else {
        statusElement.innerHTML = "<span class='badge badge-success'>‚úÖ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è</span>";
        progressInfoElement.textContent = "";
    }
    
    // –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
    if (data.last_updated) {
        const lastUpdated = new Date(data.last_updated);
        document.getElementById("last-updated").innerHTML = 
            "<span class='text-success'>" + lastUpdated.toLocaleString("uk-UA") + "</span>";
    }
    
    // –ß–∞—Å–∏ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π
    const lastSearchElement = document.getElementById("last-search");
    const lastExtractionElement = document.getElementById("last-extraction");
    
    if (data.last_search_run) {
        const lastSearch = new Date(data.last_search_run);
        lastSearchElement.textContent = "–ü–æ—à—É–∫: " + lastSearch.toLocaleString("uk-UA");
    } else {
        lastSearchElement.textContent = "–ü–æ—à—É–∫: –Ω–µ –∑–∞–ø—É—Å–∫–∞–≤—Å—è";
    }
    
    if (data.last_extraction_run) {
        const lastExtraction = new Date(data.last_extraction_run);
        lastExtractionElement.textContent = "–í–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è: " + lastExtraction.toLocaleString("uk-UA");
    } else {
        lastExtractionElement.textContent = "–í–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è: –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–æ—Å—è";
    }
}

function startMonitoringUpdates() {
    // –ü–µ—Ä—à–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    fetchMonitoringStats();
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥
    monitoringInterval = setInterval(fetchMonitoringStats, 10000);
}

function stopMonitoringUpdates() {
    if (monitoringInterval) {
        clearInterval(monitoringInterval);
    }
}

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∫–∞—Ä—É—Å–µ–ª—å —Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener("DOMContentLoaded", function() {
    console.log("üöÄ DOM –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ, —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏...");
    renderCarousel();
    startMonitoringUpdates();
    console.log("‚úÖ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
});

// –ó—É–ø–∏–Ω—è—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ –≤–∏—Ö–æ–¥—ñ –∑—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener("beforeunload", function() {
    stopMonitoringUpdates();
});
</script>
{% endblock %}