{% extends "base.html" %}

{% block title %}–°—É–¥–æ–≤—ñ —Ä—ñ—à–µ–Ω–Ω—è - –ê–Ω–∞–ª—ñ–∑ –∫–ª—ñ—î–Ω—Ç—ñ–≤{% endblock %}

{% block extra_css %}
<style>
/* –°—Ç–∏–ª—ñ –¥–ª—è —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ—ó –≤–∏—Å–æ—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –±–µ–∑ —Å–∫—Ä–æ–ª—É */
html, body {
    height: 100%;
    overflow: hidden;
}

.main-container {
    height: calc(100vh - 56px); /* –í—Ä–∞—Ö–æ–≤—É—î–º–æ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—é */
    display: flex;
    flex-direction: column;
    padding: 8px;
    overflow: hidden;
}

/* –ö–æ–º–ø–∞–∫—Ç–Ω—ñ —Å—Ç–∏–ª—ñ */
.page-header {
    margin-bottom: 8px;
    flex-shrink: 0;
}

.page-header h1 {
    font-size: 1.5rem;
    margin-bottom: 4px;
}

.stats-section {
    margin-bottom: 8px;
    flex-shrink: 0;
}

.stats-section .row {
    display: flex;
    align-items: stretch;
}

.stats-section .card {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.stats-section .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
}


.card-header {
    padding: 3px 5px;
    font-size: 0.85rem;
}

.card-body {
    padding: 3px 5px;
}

.card-title {
    font-size: 1.2rem;
    margin-bottom: 2px;
}

.card-text {
    font-size: 0.8rem;
    margin-bottom: 0;
}

/* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω—ñ —Å–µ–∫—Ü—ñ—ó */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 6px;
    margin-bottom: 8px;
    align-items: stretch;
}

.stat-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 3px 5px;
    text-align: left;
    display: flex;
    flex-direction: column;
    min-height: 80px;
    max-height: none;
    overflow: visible;
    word-wrap: break-word;
}

.stat-card h6 {
    font-size: 0.75rem;
    margin-bottom: 2px;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
    line-height: 1.1;
}

.stat-value {
    font-size: 1.1rem;
    font-weight: bold;
    color: #495057;
    margin-bottom: 2px;
    line-height: 1.2;
}

.stat-label {
    font-size: 0.7rem;
    color: #6c757d;
    margin-bottom: 2px;
    line-height: 1.1;
}

/* –°–µ–∫—Ü—ñ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
.stats-section {
    margin-bottom: 8px;
}

.stats-section-detailed {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow: visible;
    min-height: 0;
}

.stats-section-detailed > div {
    background: #fafbfc;
    border: 1px solid #e8e9ea;
    border-radius: 6px;
    padding: 8px;
    margin-bottom: 6px;
    overflow: visible;
    min-height: 120px;
}

.stats-section h4, .stats-section-detailed h4 {
    font-size: 1rem;
    margin-bottom: 8px;
    color: #495057;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 2px;
}

/* –†–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –±–ª–æ–∫—ñ–≤ */
.period-info {
    font-size: 0.65rem;
    color: #6c757d;
    margin-bottom: 4px;
    font-style: italic;
}

.card {
    margin-bottom: 8px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    border: 1px solid #e8e9ea !important;
}

.card:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    transition: box-shadow 0.2s ease;
}



.refresh-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    cursor: pointer;
    margin-left: 8px;
}

.refresh-btn:hover {
    background: #218838;
}


/* –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è */
.no-data {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 8px;
    font-size: 0.8rem;
}

.loading {
    text-align: center;
    padding: 8px;
    color: #6c757d;
    font-size: 0.8rem;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 6px 8px;
    border-radius: 4px;
    margin-bottom: 8px;
    font-size: 0.8rem;
}

.success-message {
    background: #d4edda;
    color: #155724;
    padding: 6px 8px;
    border-radius: 4px;
    margin-bottom: 8px;
    font-size: 0.8rem;
}

.auto-refresh-indicator {
    display: inline-block;
    width: 6px;
    height: 6px;
    background: #28a745;
    border-radius: 50%;
    margin-left: 5px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* –Ü—î—Ä–∞—Ä—Ö—ñ—á–Ω–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è */
.breadcrumb-item {
    display: inline-block;
    padding: 2px 8px;
    margin-right: 4px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.75rem;
    transition: all 0.2s ease;
}

.breadcrumb-item:hover {
    background: #e9ecef;
}

.breadcrumb-item.active {
    background: #007bff;
    color: white;
    cursor: default;
}

.breadcrumb-item.active:hover {
    background: #007bff;
}

.breadcrumb-separator {
    margin: 0 4px;
    color: #6c757d;
}

/* –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ñ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
.stat-card.clickable {
    cursor: pointer;
    transition: all 0.2s ease;
}

.stat-card.clickable:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    background: #f8f9fa;
}
</style>
{% endblock %}

{% block main_content %}
<div class="main-container">
    <!-- –ö–æ–º–ø–∞–∫—Ç–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="page-header">
        <h1>–°—É–¥–æ–≤—ñ —Ä—ñ—à–µ–Ω–Ω—è <span class="auto-refresh-indicator"></span></h1>
        {% if using_cache %}
        <div style="font-size: 0.6rem; color: #6c757d; margin-top: 1px;">
            üìä –î–∞–Ω—ñ –∑ –∫–µ—à—É (–æ–Ω–æ–≤–ª–µ–Ω–æ –∑–∞ –∫–∏—ó–≤—Å—å–∫–∏–º —á–∞—Å–æ–º)
        </div>
        {% endif %}
    </div>

    <!-- –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div>
        <h4>üìä –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—É–¥–æ–≤–∏—Ö —Ä—ñ—à–µ–Ω—å</h4>
        <div class="stats-grid">
            <div class="stat-card">
                <h6>–ó–∞ –≤–µ—Å—å –ø–µ—Ä—ñ–æ–¥ ({{ available_tables }} –±–∞–∑ –¥–∞–Ω–∏—Ö)</h6>
                <div class="stat-label"><span class="stat-value">{{ total_stats.total_decisions|floatformat:0 }}</span> —Ä—ñ—à–µ–Ω—å</div>
                <div style="font-size: 0.6em; text-align: left; line-height: 1.2; margin-top: 2px;">
                    <div style="margin-bottom: 1px;">–£–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö —Å—É–¥—ñ–≤: {{ total_stats.total_courts }}</div>
                    {% if total_stats.date_range %}
                        <div style="margin-bottom: 1px;">–ü–µ—Ä—ñ–æ–¥: {{ total_stats.date_range.min|date:"Y" }} - {{ total_stats.date_range.max|date:"Y" }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-section-detailed">

        <!-- –Ü—î—Ä–∞—Ä—Ö—ñ—á–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Ä–æ–∫–∞–º–∏ -->
        <div>
            <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Ä–æ–∫–∞–º–∏ <button class="refresh-btn" onclick="refreshHierarchicalStats()">üîÑ</button></h4>
            <div id="hierarchical-breadcrumb" style="font-size: 0.65rem; color: #6c757d; margin-bottom: 4px;">
                <span class="breadcrumb-item active" onclick="loadYearlyStats()">–†–æ–∫–∏</span>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É -->
            <div id="hierarchical-filters" style="display: none; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 8px; margin-bottom: 8px;">
                <div class="row g-2" style="align-items: end;">
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–†—ñ–∫:</label>
                        <select id="filter-year" class="form-control form-control-sm">
                            <option value="">–í—Å—ñ —Ä–æ–∫–∏</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–í–∏–¥ —Å—É–¥–æ—á–∏–Ω—Å—Ç–≤–∞:</label>
                        <select id="filter-justice-kind" class="form-control form-control-sm">
                            <option value="">–í—Å—ñ –≤–∏–¥–∏</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–Ü–Ω—Å—Ç–∞–Ω—Ü—ñ—è:</label>
                        <select id="filter-instance" class="form-control form-control-sm">
                            <option value="">–í—Å—ñ —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—ó</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–§–æ—Ä–º–∞ —Ä—ñ—à–µ–Ω–Ω—è:</label>
                        <select id="filter-judgment" class="form-control form-control-sm">
                            <option value="">–í—Å—ñ —Ñ–æ—Ä–º–∏</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–°—É–¥:</label>
                        <select id="filter-court-stats" class="form-control form-control-sm">
                            <option value="">–í—Å—ñ —Å—É–¥–∏</option>
                            <option value="loading" disabled>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>
                        </select>
                    </div>
                    <div class="col-md-2" style="display: flex; align-items: end; gap: 5px;">
                        <button id="apply-hierarchical-filters" class="btn btn-primary btn-sm" style="font-size: 0.8em; display: none;">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
                        <button id="clear-hierarchical-filters" class="btn btn-secondary btn-sm" style="font-size: 0.8em;">–û—á–∏—Å—Ç–∏—Ç–∏</button>
                    </div>
                </div>
            </div>

            <div class="stats-grid" id="hierarchical-stats">
                <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>
            </div>
        </div>

        <!-- –§—ñ–ª—å—Ç—Ä–∏ –¥–ª—è —Å–ø–∏—Å–∫—É —Å—É–¥–æ–≤–∏—Ö —Ä—ñ—à–µ–Ω—å -->
        <div id="document-filters-section" style="display: none; background: #fff; border: 2px solid #007bff; border-radius: 8px; padding: 15px; margin: 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="margin-bottom: 10px;">
                <button id="toggle-filters" class="btn btn-sm btn-outline-secondary">
                    üìã <span id="filter-toggle-text">–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏</span> —Ñ—ñ–ª—å—Ç—Ä–∏
                </button>
            </div>

            <div id="filters-content" style="display: none; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; margin-bottom: 10px;">
                <div class="row g-2">
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–¢–æ—á–Ω–∞ –¥–∞—Ç–∞:</label>
                        <input type="date" id="filter-exact-date" class="form-control form-control-sm">
                        <small class="text-muted" style="font-size: 0.7em;">–∞–±–æ –ø–µ—Ä—ñ–æ–¥ –Ω–∏–∂—á–µ</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–î–∞—Ç–∞ –≤—ñ–¥:</label>
                        <input type="date" id="filter-date-from" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–î–∞—Ç–∞ –¥–æ:</label>
                        <input type="date" id="filter-date-to" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–ù–æ–º–µ—Ä —Å–ø—Ä–∞–≤–∏:</label>
                        <input type="text" id="filter-case-number" class="form-control form-control-sm" placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 910/1539">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–°—É–¥–¥—è:</label>
                        <input type="text" id="filter-judge" class="form-control form-control-sm" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ —Å—É–¥–¥—ñ">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–°—É–¥:</label>
                        <select id="filter-court-main" class="form-control form-control-sm">
                            <option value="">–í—Å—ñ —Å—É–¥–∏</option>
                        </select>
                    </div>
                </div>
                <div class="row g-2 mt-2">
                    <div class="col-md-12" style="text-align: right;">
                        <button id="apply-filters" class="btn btn-primary btn-sm">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
                        <button id="clear-filters" class="btn btn-secondary btn-sm">–û—á–∏—Å—Ç–∏—Ç–∏</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è —ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω–æ—ó –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
let currentHierarchyLevel = "years";
let hierarchyData = {
    year: "",
    justice_kind: "",
    instance_code: "",
    judgment_form: ""
};
let refreshInterval;

// –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
let hierarchicalFilters = {
    year: "",
    justice_kind: "",
    instance_code: "",
    judgment_code: "",
    court_code: ""
};


/*
function addFiltersToggleButton() {
    const header = document.querySelector('h4'); // –ú–æ–∂–µ –∑–Ω–∞–π—Ç–∏ –Ω–µ —Ç–æ–π h4
    console.log("Header found:", header?.textContent);
    if (header && header.textContent.includes('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Ä–æ–∫–∞–º–∏') && !document.getElementById('toggle-hierarchical-filters')) {
        const toggleButton = document.createElement('button');
        toggleButton.id = 'toggle-hierarchical-filters';
        toggleButton.className = 'btn btn-outline-secondary btn-sm ms-2';
        toggleButton.innerHTML = 'üîç –§—ñ–ª—å—Ç—Ä–∏';
        toggleButton.style.fontSize = '0.75rem';

        toggleButton.addEventListener('click', function() {
            const filtersPanel = document.getElementById('hierarchical-filters');
            if (filtersPanel.style.display === 'none') {
                showHierarchicalFilters();
                toggleButton.innerHTML = 'üîç –•–æ–≤–∞—Ç–∏';
            } else {
                hideHierarchicalFilters();
                toggleButton.innerHTML = 'üîç –§—ñ–ª—å—Ç—Ä–∏';
            }
        });

        header.appendChild(toggleButton);
    }
}
*/

function testLoadYearlyStats() {
    console.log("Starting test function");
    const container = document.getElementById("hierarchical-stats");
    if (!container) {
        console.error("Container not found!");
        return;
    }

    container.innerHTML = "<div>–¢–µ—Å—Ç: JavaScript –ø—Ä–∞—Ü—é—î!</div>";

    // –ü—Ä–æ—Å—Ç–∏–π fetch —Ç–µ—Å—Ç
    fetch("/api/court-decisions/hierarchical-stats/")
    .then(function(response) {
        console.log("Response:", response.status);
        return response.json();
    })
    .then(function(data) {
        console.log("Data received:", data);
        if (data.data && data.data.length > 0) {
            container.innerHTML = "<div>–¢–µ—Å—Ç –ø—Ä–æ–π—à–æ–≤: –æ—Ç—Ä–∏–º–∞–Ω–æ " + data.data.length + " —Ä–æ–∫—ñ–≤</div>";
            // –í–∏–∫–ª–∏–∫–∞—î–º–æ —Å–ø—Ä–∞–≤–∂–Ω—é —Ñ—É–Ω–∫—Ü—ñ—é
            setTimeout(function() {
                loadYearlyStats();
            }, 2000);
        } else {
            container.innerHTML = "<div>–¢–µ—Å—Ç: –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö</div>";
        }
    })
    .catch(function(error) {
        console.error("Test error:", error);
        container.innerHTML = "<div>–¢–µ—Å—Ç: –ø–æ–º–∏–ª–∫–∞ " + error.message + "</div>";
    });
}

document.addEventListener("DOMContentLoaded", function() {
    console.log("DOM loaded, starting simple test");

    // –ü—Ä–æ—Å—Ç–∏–π —Ç–µ—Å—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    testLoadYearlyStats();

    // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 5 —Ö–≤–∏–ª–∏–Ω
    refreshInterval = setInterval(refreshAllStats, 300000);

    // –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ (–≤—ñ–¥–∫–ª–∞–¥–µ–º–æ —Ü–µ)
    // setTimeout(() => {
    //     addFiltersToggleButton();
    // }, 1000);
});

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—Å—ñ—î—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
async function refreshAllStats() {
    showRefreshIndicator();
    
    try {
        const response = await fetch("{% url 'bankruptcy:court_decisions_stats_api' %}");
        const data = await response.json();
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –¢–û–ü —Å—É–¥—ñ–≤
        updateTopCourts(data.top_courts);
        
        // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        await refreshCurrentHierarchyLevel();
        
    } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", error);
    }
    
    hideRefreshIndicator();
}

// –Ü—î—Ä–∞—Ä—Ö—ñ—á–Ω–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è
async function loadYearlyStats(forceRefresh = false) {
    currentHierarchyLevel = "years";
    hierarchyData = { year: "", justice_kind: "", instance_code: "", judgment_form: "" };
    updateBreadcrumb();

    const container = document.getElementById("hierarchical-stats");
    container.innerHTML = "<div class='loading'>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑–∞ —Ä–æ–∫–∞–º–∏...</div>";

    try {
        const url = new URL("{% url 'bankruptcy:hierarchical_court_decisions_stats_api' %}", window.location.origin);
        if (forceRefresh) {
            url.searchParams.set("force_refresh", "true");
        }

        const response = await fetch(url);
        const data = await response.json();

        if (data.data && data.data.length > 0) {
            displayYearlyStats(data.data);
        } else {
            container.innerHTML = "<div class='no-data'>–î–∞–Ω—ñ –∑–∞ —Ä–æ–∫–∞–º–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ</div>";
        }
    } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä—ñ—á–Ω–æ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", error);
        container.innerHTML = "<div class='error-message'>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö</div>";
    }
}

function resetContainerStyles() {
    const container = document.getElementById("hierarchical-stats");
    // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ —Å—ñ—Ç–∫–∏
    container.style.cssText = '';

    // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤
    const filtersSection = document.getElementById("document-filters-section");
    if (filtersSection) {
        filtersSection.style.display = "none";
    }
}

function displayYearlyStats(yearsData) {
    const container = document.getElementById("hierarchical-stats");
    container.innerHTML = "";
    resetContainerStyles();

    yearsData.forEach(yearData => {
        const yearCard = document.createElement("div");
        yearCard.className = "stat-card clickable";
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ year_short –¥–ª—è URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
        yearCard.onclick = () => loadJusticeKindsForYear(yearData.year_short || yearData.year);
        
        // –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–≥–∞–ª—å–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –ø–æ –≤—Å—ñ—Ö –≤–∏–¥–∞—Ö —Å—É–¥–æ—á–∏–Ω—Å—Ç–≤–∞
        const totalCount = yearData.justice_kinds.reduce((sum, jk) => sum + jk.count, 0);
        
        var justiceKindsHtml = yearData.justice_kinds.map(function(jk) {
            return '<div style="margin-bottom: 1px;">' + jk.name + ': ' + formatNumber(jk.count) + '</div>';
        }).join("");

        yearCard.innerHTML =
            '<h6>' + yearData.year + '</h6>' +
            '<div class="stat-label"><span class="stat-value">' + formatNumber(totalCount) + '</span> —Ä—ñ—à–µ–Ω—å</div>' +
            '<div style="font-size: 0.6em; text-align: left; line-height: 1.2; margin-top: 2px; overflow: visible;">' +
                justiceKindsHtml +
            '</div>';
        container.appendChild(yearCard);
    });
}

async function loadJusticeKindsForYear(year, forceRefresh = false) {
    currentHierarchyLevel = "justice_kinds";
    hierarchyData.year = year;
    hierarchyData.justice_kind = "";
    hierarchyData.instance_code = "";
    hierarchyData.judgment_form = "";
    updateBreadcrumb();
    
    const container = document.getElementById("hierarchical-stats");
    container.innerHTML = "<div class='loading'>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–∏–¥—ñ–≤ —Å—É–¥–æ—á–∏–Ω—Å—Ç–≤–∞...</div>";
    
    try {
        const url = new URL("{% url 'bankruptcy:hierarchical_court_decisions_stats_api' %}", window.location.origin);
        url.searchParams.set("year", year);
        if (forceRefresh) {
            url.searchParams.set("force_refresh", "true");
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.data && data.data.length > 0) {
            displayJusticeKinds(data.data);
        } else {
            container.innerHTML = "<div class='no-data'>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø–æ –≤–∏–¥–∞—Ö —Å—É–¥–æ—á–∏–Ω—Å—Ç–≤–∞</div>";
        }
    } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–∏–¥—ñ–≤ —Å—É–¥–æ—á–∏–Ω—Å—Ç–≤–∞:", error);
        container.innerHTML = "<div class='error-message'>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö</div>";
    }
}

function displayJusticeKinds(justiceKinds) {
    const container = document.getElementById("hierarchical-stats");
    container.innerHTML = "";
    resetContainerStyles();
    
    justiceKinds.forEach(jk => {
        const kindCard = document.createElement("div");
        kindCard.className = "stat-card clickable";
        kindCard.onclick = () => loadInstancesForJusticeKind(jk.code, jk.name);
        
        kindCard.innerHTML = "<h6>" + jk.name + "</h6>" +
            "<div class='stat-label'><span class='stat-value'>" + formatNumber(jk.count) + "</span> —Ä—ñ—à–µ–Ω—å</div>" +
            "<div style='font-size: 0.6em; text-align: left; line-height: 1.2; margin-top: 2px; overflow: visible;'>" +
            (jk.instances && jk.instances.length > 0 ?
                jk.instances.map(function(inst) {
                    return "<div style='margin-bottom: 1px;'>" + inst.name + ": " + formatNumber(inst.count) + "</div>";
                }).join("") :
                "<div style='margin-bottom: 1px;'>–î–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è...</div>") +
            "</div>";
        container.appendChild(kindCard);
    });
}

async function loadInstancesForJusticeKind(justiceKind, justiceKindName) {
    currentHierarchyLevel = "instances";
    hierarchyData.justice_kind = justiceKind;
    hierarchyData.justice_kind_name = justiceKindName;
    hierarchyData.instance_code = "";
    hierarchyData.judgment_form = "";
    updateBreadcrumb();
    
    const container = document.getElementById("hierarchical-stats");
    container.innerHTML = "<div class='loading'>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ–π...</div>";
    
    try {
        const url = "{% url 'bankruptcy:hierarchical_court_decisions_stats_api' %}" + "?year=" + hierarchyData.year + "&justice_kind=" + justiceKind;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.data && data.data.length > 0) {
            displayInstances(data.data);
        } else {
            container.innerHTML = "<div class='no-data'>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø–æ —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—è—Ö</div>";
        }
    } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ–π:", error);
        container.innerHTML = "<div class='error-message'>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö</div>";
    }
}

function displayInstances(instances) {
    const container = document.getElementById("hierarchical-stats");
    container.innerHTML = "";
    resetContainerStyles();
    
    instances.forEach(instance => {
        const instanceCard = document.createElement("div");
        instanceCard.className = "stat-card clickable";
        instanceCard.onclick = () => loadJudgmentFormsForInstance(instance.code, instance.name);
        
        instanceCard.innerHTML = "<h6>" + instance.name + "</h6>" +
            "<div class='stat-label'><span class='stat-value'>" + formatNumber(instance.count) + "</span> —Ä—ñ—à–µ–Ω—å</div>" +
            "<div style='font-size: 0.6em; text-align: left; line-height: 1.2; margin-top: 2px; overflow: visible;'>" +
            (instance.judgment_forms && instance.judgment_forms.length > 0 ?
                instance.judgment_forms.map(function(jf) {
                    return "<div style='margin-bottom: 1px;'>" + jf.name + ": " + formatNumber(jf.count) + "</div>";
                }).join("") :
                "<div style='margin-bottom: 1px;'>–î–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è...</div>") +
            "</div>";
        container.appendChild(instanceCard);
    });
}

async function loadJudgmentFormsForInstance(instanceCode, instanceName) {
    currentHierarchyLevel = "judgment_forms";
    hierarchyData.instance_code = instanceCode;
    hierarchyData.instance_name = instanceName;
    hierarchyData.judgment_form = "";
    updateBreadcrumb();
    
    const container = document.getElementById("hierarchical-stats");
    container.innerHTML = "<div class='loading'>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ä–º —Ä—ñ—à–µ–Ω—å...</div>";
    
    try {
        const url = "{% url 'bankruptcy:hierarchical_court_decisions_stats_api' %}" + "?year=" + hierarchyData.year + "&justice_kind=" + hierarchyData.justice_kind + "&instance_code=" + instanceCode;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.data && data.data.length > 0) {
            displayJudgmentForms(data.data);
        } else {
            container.innerHTML = "<div class='no-data'>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø–æ —Ñ–æ—Ä–º–∞—Ö —Ä—ñ—à–µ–Ω—å</div>";
        }
    } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ä–º —Ä—ñ—à–µ–Ω—å:", error);
        container.innerHTML = "<div class='error-message'>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö</div>";
    }
}

function displayJudgmentForms(judgmentForms) {
    const container = document.getElementById("hierarchical-stats");
    container.innerHTML = "";
    resetContainerStyles();
    
    judgmentForms.forEach(jf => {
        const formCard = document.createElement("div");
        formCard.className = "stat-card clickable";
        formCard.onclick = () => loadDetailedStats(jf.code, jf.name);
        
        formCard.innerHTML = "<h6>" + jf.name + "</h6>" +
            "<div class='stat-label'><span class='stat-value'>" + formatNumber(jf.count) + "</span> —Ä—ñ—à–µ–Ω—å</div>";
        container.appendChild(formCard);
    });
}

async function loadDetailedStats(judgmentForm, judgmentFormName) {
    currentHierarchyLevel = "decisions";
    hierarchyData.judgment_form = judgmentForm;
    hierarchyData.judgment_form_name = judgmentFormName;
    updateBreadcrumb();

    await loadCourtDecisionsList(1); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–µ—Ä—à—É —Å—Ç–æ—Ä—ñ–Ω–∫—É
}

function displayDetailedStats(details) {
    const container = document.getElementById("hierarchical-stats");
    container.innerHTML = "";
    
    const detailCard = document.createElement("div");
    detailCard.className = "stat-card";
    
    detailCard.innerHTML = "<h6>–î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h6>" +
        "<div style='font-size: 0.6em; text-align: left; line-height: 1.2; margin-top: 2px;'>" +
        "<div style='margin-bottom: 1px;'><strong>–í—Å—å–æ–≥–æ —Ä—ñ—à–µ–Ω—å:</strong> " + formatNumber(details.total_count) + "</div>" +
        "<div style='margin-bottom: 1px;'><strong>–£–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö —Å—É–¥—ñ–≤:</strong> " + formatNumber(details.courts_count) + "</div>" +
        (details.min_date ? "<div style='margin-bottom: 1px;'><strong>–ü–µ—Ä—à–µ —Ä—ñ—à–µ–Ω–Ω—è:</strong> " + formatDate(details.min_date) + "</div>" : "") +
        (details.max_date ? "<div style='margin-bottom: 1px;'><strong>–û—Å—Ç–∞–Ω–Ω—î —Ä—ñ—à–µ–Ω–Ω—è:</strong> " + formatDate(details.max_date) + "</div>" : "") +
        "</div>";
    container.appendChild(detailCard);
}

async function loadCourtDecisionsList(page = 1) {
    const container = document.getElementById("hierarchical-stats");
    container.innerHTML = "<div class='loading'>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—É–¥–æ–≤–∏—Ö —Ä—ñ—à–µ–Ω—å...</div>";

    try {
        const url = new URL("{% url 'bankruptcy:court_decisions_list_api' %}", window.location.origin);
        url.searchParams.set('year', hierarchyData.year);
        url.searchParams.set('justice_kind', hierarchyData.justice_kind);
        url.searchParams.set('instance_code', hierarchyData.instance_code);
        url.searchParams.set('judgment_code', hierarchyData.judgment_form);
        url.searchParams.set('page', page.toString());
        url.searchParams.set('per_page', '100');

        // –î–æ–¥–∞—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏, —è–∫—â–æ –≤–æ–Ω–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ
        if (currentFilters) {
            Object.keys(currentFilters).forEach(key => {
                if (currentFilters[key]) {
                    url.searchParams.set(key, currentFilters[key]);
                }
            });
        }

        // –î–æ–¥–∞—î–º–æ —ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω–∏–π —Ñ—ñ–ª—å—Ç—Ä —Å—É–¥—É, —è–∫—â–æ –≤—ñ–Ω –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π
        if (hierarchicalFilters && hierarchicalFilters.court_code) {
            url.searchParams.set('court', hierarchicalFilters.court_code);
        }

        console.log("Fetching court decisions from:", url.toString());
        console.log("HierarchyData:", hierarchyData);
        const response = await fetch(url);
        console.log("Response status:", response.status, response.ok);

        const data = await response.json();
        console.log("Court decisions data:", data);

        if (data.error) {
            container.innerHTML = "<div class='error-message'>" + data.error + "</div>";
            return;
        }

        displayCourtDecisionsList(data);
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—É–¥–æ–≤–∏—Ö —Ä—ñ—à–µ–Ω—å:', error);
        container.innerHTML = "<div class='error-message'>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö</div>";
    }
}

function displayCourtDecisionsList(data) {
    const container = document.getElementById("hierarchical-stats");
    container.innerHTML = "";

    // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–æ–≤–Ω—ñ—à–Ω—é —Å–µ–∫—Ü—ñ—é —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    const externalFiltersSection = document.getElementById("document-filters-section");
    if (externalFiltersSection) {
        externalFiltersSection.style.display = "none";
    }

    // –ó–º—ñ–Ω—é—î–º–æ —Å—Ç–∏–ª—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É
    container.style.cssText = 'display: block; width: 100%; max-width: none;';

    if (!data.decisions || data.decisions.length === 0) {
        container.innerHTML = "<div class='no-data'>–†—ñ—à–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ</div>";
        return;
    }

    // –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    const filtersDiv = document.createElement('div');
    filtersDiv.innerHTML = `
        <div style="background: #fff; border: 2px solid #007bff; border-radius: 8px; padding: 15px; margin: 0 0 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="margin-bottom: 10px;">
                <button id="toggle-filters" class="btn btn-sm btn-outline-secondary">
                    üìã <span id="filter-toggle-text">–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏</span> —Ñ—ñ–ª—å—Ç—Ä–∏
                </button>
            </div>

            <div id="filters-content" style="display: none; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; margin-bottom: 10px;">
                <div class="row g-2">
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–¢–æ—á–Ω–∞ –¥–∞—Ç–∞:</label>
                        <input type="date" id="filter-exact-date" class="form-control form-control-sm">
                        <small class="text-muted" style="font-size: 0.7em;">–∞–±–æ –ø–µ—Ä—ñ–æ–¥ –Ω–∏–∂—á–µ</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–î–∞—Ç–∞ –≤—ñ–¥:</label>
                        <input type="date" id="filter-date-from" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–î–∞—Ç–∞ –¥–æ:</label>
                        <input type="date" id="filter-date-to" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–ù–æ–º–µ—Ä —Å–ø—Ä–∞–≤–∏:</label>
                        <input type="text" id="filter-case-number" class="form-control form-control-sm" placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 910/1539">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–°—É–¥–¥—è:</label>
                        <input type="text" id="filter-judge" class="form-control form-control-sm" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ —Å—É–¥–¥—ñ">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" style="font-size: 0.8em; font-weight: bold;">–°—É–¥:</label>
                        <select id="filter-court-main" class="form-control form-control-sm">
                            <option value="">–í—Å—ñ —Å—É–¥–∏</option>
                        </select>
                    </div>
                </div>
                <div class="row g-2 mt-2">
                    <div class="col-md-12" style="text-align: right;">
                        <button id="apply-filters" class="btn btn-primary btn-sm">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
                        <button id="clear-filters" class="btn btn-secondary btn-sm">–û—á–∏—Å—Ç–∏—Ç–∏</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    container.appendChild(filtersDiv);

    /*
    // –ü–∞–Ω–µ–ª—å —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ - —Ç–∏–º—á–∞—Å–æ–≤–æ –∑–∞–∫–æ–º–µ–Ω—Ç–æ–≤–∞–Ω–æ
    const filtersPanel = document.createElement('div');
    filtersPanel.className = 'filters-panel';
    filtersPanel.innerHTML = '<div>Filters temporarily disabled</div>';
    container.appendChild(filtersPanel);
    */

    // –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∞ –ø–∞–Ω–µ–ª—å
    const infoPanel = document.createElement('div');
    infoPanel.className = 'info-panel';
    infoPanel.innerHTML =
        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">' +
            '<h6>–°—É–¥–æ–≤—ñ —Ä—ñ—à–µ–Ω–Ω—è (' + formatNumber(data.pagination.total_count) + ')</h6>' +
            '<div style="font-size: 0.8em; color: #666;">' +
                '–°—Ç–æ—Ä—ñ–Ω–∫–∞ ' + data.pagination.page + ' –∑ ' + data.pagination.total_pages +
            '</div>' +
        '</div>';
    container.appendChild(infoPanel);

    // –¢–∞–±–ª–∏—Ü—è —Ä—ñ—à–µ–Ω—å
    const tableContainer = document.createElement('div');
    tableContainer.className = 'decisions-table-container';
    tableContainer.style.cssText = 'width: 100%; max-height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;';

    const table = document.createElement('table');
    table.className = 'table table-striped table-sm decisions-table';
    table.style.cssText = 'width: 100%; table-layout: fixed; margin: 0;';
    table.innerHTML =
        "<thead class='table-dark' style='position: sticky; top: 0; z-index: 10;'>" +
            "<tr>" +
                "<th style='width: 9%;'>–î–∞—Ç–∞</th>" +
                "<th style='width: 13%;'>–ù–æ–º–µ—Ä —Å–ø—Ä–∞–≤–∏</th>" +
                "<th style='width: 18%;'>–°—É–¥–¥—è</th>" +
                "<th style='width: 30%;'>–°—É–¥</th>" +
                "<th style='width: 10%;'>–¢–∏–ø —Ä—ñ—à–µ–Ω–Ω—è</th>" +
                "<th style='width: 10%;'>–Ñ–î–†–°–†</th>" +
                "<th style='width: 10%;'>–î–æ–∫—É–º–µ–Ω—Ç</th>" +
            "</tr>" +
        "</thead>" +
        "<tbody>" +
            data.decisions.map(function(decision) {
                return "<tr>" +
                    "<td style='font-size: 0.75em; white-space: nowrap;'>" + (decision.adjudication_date ? formatDate(decision.adjudication_date) : '-') + "</td>" +
                    "<td style='font-size: 0.75em; font-family: monospace; word-break: break-word;'>" + (decision.case_number || '-') + "</td>" +
                    "<td style='font-size: 0.75em; word-wrap: break-word; overflow-wrap: break-word;'>" + (decision.judge || '-') + "</td>" +
                    "<td style='font-size: 0.65em; word-wrap: break-word; overflow-wrap: break-word;'>" +
                        "<div style='font-weight: bold; margin-bottom: 2px;'>" + (decision.court_name || '-') + "</div>" +
                        (decision.region_code ? "<div style='color: #666; font-size: 0.9em;'>üèõÔ∏è –†–µ–≥—ñ–æ–Ω: " + decision.region_code + "</div>" : '') +
                        (decision.court_code ? "<div style='color: #888; font-size: 0.85em; font-family: monospace;'>–ö–æ–¥: " + decision.court_code + "</div>" : '') +
                    "</td>" +
                    "<td style='font-size: 0.75em; white-space: nowrap;'>" + (decision.judgment_form_name || '-') + "</td>" +
                    "<td style='text-align: center;'>" +
                        (decision.doc_id ?
                            "<a href='https://reyestr.court.gov.ua/Review/" + decision.doc_id + "' target='_blank' class='btn btn-sm btn-outline-success' style='font-size: 0.6em; padding: 2px 6px;' title='–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤ –Ñ–î–†–°–†'>üîç</a>" :
                            "<span style='color: #999; font-size: 0.7em;'>-</span>"
                        ) +
                    "</td>" +
                    "<td style='text-align: center;'>" +
                        (decision.doc_url ?
                            "<a href='" + decision.doc_url + "' target='_blank' class='btn btn-sm btn-outline-primary' style='font-size: 0.6em; padding: 2px 6px;' title='–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ RTF –¥–æ–∫—É–º–µ–Ω—Ç'>üìÑ</a>" :
                            "<span style='color: #999; font-size: 0.7em;'>-</span>"
                        ) +
                    "</td>" +
                "</tr>";
            }).join('') +
        "</tbody>";

    tableContainer.appendChild(table);
    container.appendChild(tableContainer);

    // –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è
    if (data.pagination.total_pages > 1) {
        const pagination = createPagination(data.pagination);
        container.appendChild(pagination);
    }

    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    setupFiltersHandlers();

    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ —Å—É–¥—ñ–≤ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –∑ –Ω–µ–≤–µ–ª–∏–∫–æ—é –∑–∞—Ç—Ä–∏–º–∫–æ—é
    setTimeout(() => {
        loadCourtsForFilters();
    }, 100);
}

function createPagination(paginationData) {
    const paginationContainer = document.createElement('div');
    paginationContainer.className = 'pagination-container';
    paginationContainer.style.cssText = 'text-align: center; margin-top: 15px;';

    const pagination = document.createElement('nav');
    const ul = document.createElement('ul');
    ul.className = 'pagination pagination-sm justify-content-center';

    // –ü–æ–ø–µ—Ä–µ–¥–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞
    if (paginationData.has_prev) {
        const prevLi = document.createElement('li');
        prevLi.className = 'page-item';
        prevLi.innerHTML = "<a class='page-link' href='#' onclick='loadCourtDecisionsList(" + (paginationData.page - 1) + "); return false;'>¬´ –ü–æ–ø–µ—Ä–µ–¥–Ω—è</a>";
        ul.appendChild(prevLi);
    }

    // –ù–æ–º–µ—Ä–∏ —Å—Ç–æ—Ä—ñ–Ω–æ–∫ (–ø–æ–∫–∞–∑—É—î–º–æ 5 —Å—Ç–æ—Ä—ñ–Ω–æ–∫ –Ω–∞–≤–∫–æ–ª–æ –ø–æ—Ç–æ—á–Ω–æ—ó)
    const currentPage = paginationData.page;
    const totalPages = paginationData.total_pages;
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);

    for (let page = startPage; page <= endPage; page++) {
        const li = document.createElement('li');
        li.className = page === currentPage ? 'page-item active' : 'page-item';
        li.innerHTML = "<a class='page-link' href='#' onclick='loadCourtDecisionsList(" + page + "); return false;'>" + page + "</a>";
        ul.appendChild(li);
    }

    // –ù–∞—Å—Ç—É–ø–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞
    if (paginationData.has_next) {
        const nextLi = document.createElement('li');
        nextLi.className = 'page-item';
        nextLi.innerHTML = "<a class='page-link' href='#' onclick='loadCourtDecisionsList(" + (paginationData.page + 1) + "); return false;'>–ù–∞—Å—Ç—É–ø–Ω–∞ ¬ª</a>";
        ul.appendChild(nextLi);
    }

    pagination.appendChild(ul);
    paginationContainer.appendChild(pagination);

    return paginationContainer;
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–∏—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
let currentFilters = {};

function setupFiltersHandlers() {
    // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è/–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    const toggleButton = document.getElementById('toggle-filters');
    const filtersContent = document.getElementById('filters-content');
    const toggleText = document.getElementById('filter-toggle-text');

    if (toggleButton && filtersContent && toggleText) {
        toggleButton.addEventListener('click', function() {
            if (filtersContent.style.display === 'none') {
                filtersContent.style.display = 'block';
                toggleText.textContent = '–ó–≥–æ—Ä–Ω—É—Ç–∏';
            } else {
                filtersContent.style.display = 'none';
                toggleText.textContent = '–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏';
            }
        });
    }

    // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    const applyButton = document.getElementById('apply-filters');
    if (applyButton) {
        applyButton.addEventListener('click', applyFilters);
    }

    // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    const clearButton = document.getElementById('clear-filters');
    if (clearButton) {
        clearButton.addEventListener('click', clearFilters);
    }

    // –û–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è Enter –≤ –ø–æ–ª—è—Ö –ø–æ—à—É–∫—É
    const textInputs = ['filter-case-number', 'filter-judge', 'filter-court-main'];
    textInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });
        }
    });

    // –õ–æ–≥—ñ–∫–∞ –≤–∑–∞—î–º–æ–≤–∏–∫–ª—é—á–µ–Ω–Ω—è: —Ç–æ—á–Ω–∞ –¥–∞—Ç–∞ VS –ø–µ—Ä—ñ–æ–¥
    const exactDateInput = document.getElementById('filter-exact-date');
    const dateFromInput = document.getElementById('filter-date-from');
    const dateToInput = document.getElementById('filter-date-to');

    if (exactDateInput && dateFromInput && dateToInput) {
        exactDateInput.addEventListener('change', function() {
            if (this.value) {
                dateFromInput.value = '';
                dateToInput.value = '';
            }
        });

        [dateFromInput, dateToInput].forEach(input => {
            input.addEventListener('change', function() {
                if (dateFromInput.value || dateToInput.value) {
                    exactDateInput.value = '';
                }
            });
        });
    }
}

function applyFilters() {
    // –ó–±–∏—Ä–∞—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    currentFilters = {};

    const exactDate = document.getElementById('filter-exact-date')?.value;
    const dateFrom = document.getElementById('filter-date-from')?.value;
    const dateTo = document.getElementById('filter-date-to')?.value;
    const caseNumber = document.getElementById('filter-case-number')?.value.trim();
    const judge = document.getElementById('filter-judge')?.value.trim();
    const court = document.getElementById('filter-court-main')?.value.trim();

    if (exactDate) currentFilters.exact_date = exactDate;
    if (dateFrom) currentFilters.date_from = dateFrom;
    if (dateTo) currentFilters.date_to = dateTo;
    if (caseNumber) currentFilters.case_number = caseNumber;
    if (judge) currentFilters.judge = judge;
    if (court) currentFilters.court = court;

    // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏
    loadCourtDecisionsList(1); // –ó–∞–≤–∂–¥–∏ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –Ω–∞ –ø–µ—Ä—à—É —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
}

function clearFilters() {
    // –û—á–∏—â—É—î–º–æ –≤—Å—ñ –ø–æ–ª—è
    const filterIds = ['filter-exact-date', 'filter-date-from', 'filter-date-to',
                      'filter-case-number', 'filter-judge', 'filter-court-main'];

    filterIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
    });

    // –û—á–∏—â—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
    currentFilters = {};

    // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –±–µ–∑ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    loadCourtDecisionsList(1);
}

function updateBreadcrumb() {
    const breadcrumb = document.getElementById("hierarchical-breadcrumb");
    let breadcrumbHTML = "<span class='breadcrumb-item active' onclick='loadYearlyStats()'>–†–æ–∫–∏</span>";
    
    if (hierarchyData.year) {
        const yearClass = currentHierarchyLevel === "justice_kinds" ? "active" : "";
        breadcrumbHTML += "<span class='breadcrumb-separator'>‚Üí</span>";
        
        // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –ø–æ–≤–Ω–∏–π —Ä—ñ–∫, –∞–ª–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
        const displayYear = hierarchyData.year_display || (hierarchyData.year.toString().length <= 2 ? 
            (parseInt(hierarchyData.year) < 50 ? 2000 + parseInt(hierarchyData.year) : 1900 + parseInt(hierarchyData.year)) : 
            hierarchyData.year);
        
        breadcrumbHTML += "<span class='breadcrumb-item " + yearClass + "' onclick='loadJusticeKindsForYear(\"" + hierarchyData.year + "\")'>" + displayYear + "</span>";
    }
    
    if (hierarchyData.justice_kind) {
        const justiceClass = currentHierarchyLevel === "instances" ? "active" : "";
        breadcrumbHTML += "<span class='breadcrumb-separator'>‚Üí</span>";
        breadcrumbHTML += "<span class='breadcrumb-item " + justiceClass + "' onclick='loadInstancesForJusticeKind(\"" + hierarchyData.justice_kind + "\", \"" + hierarchyData.justice_kind_name + "\")'>" + (hierarchyData.justice_kind_name || hierarchyData.justice_kind) + "</span>";
    }
    
    if (hierarchyData.instance_code) {
        const instanceClass = currentHierarchyLevel === "judgment_forms" ? "active" : "";
        breadcrumbHTML += "<span class='breadcrumb-separator'>‚Üí</span>";
        breadcrumbHTML += "<span class='breadcrumb-item " + instanceClass + "' onclick='loadJudgmentFormsForInstance(\"" + hierarchyData.instance_code + "\", \"" + hierarchyData.instance_name + "\")'>" + (hierarchyData.instance_name || hierarchyData.instance_code) + "</span>";
    }
    
    if (hierarchyData.judgment_form) {
        breadcrumbHTML += "<span class='breadcrumb-separator'>‚Üí</span>";
        breadcrumbHTML += "<span class='breadcrumb-item active'>" + (hierarchyData.judgment_form_name || hierarchyData.judgment_form) + "</span>";
    }
    
    breadcrumb.innerHTML = breadcrumbHTML;
}

async function refreshCurrentHierarchyLevel(forceRefresh = false) {
    switch (currentHierarchyLevel) {
        case "years":
            await loadYearlyStats(forceRefresh);
            break;
        case "justice_kinds":
            await loadJusticeKindsForYear(hierarchyData.year, forceRefresh);
            break;
        case "instances":
            await loadInstancesForJusticeKind(hierarchyData.justice_kind, hierarchyData.justice_kind_name, forceRefresh);
            break;
        case "judgment_forms":
            await loadJudgmentFormsForInstance(hierarchyData.instance_code, hierarchyData.instance_name, forceRefresh);
            break;
        case "details":
            await loadDetailedStats(hierarchyData.judgment_form, hierarchyData.judgment_form_name, forceRefresh);
            break;
    }
}

async function refreshHierarchicalStats() {
    const button = event.target;
    const originalText = button.textContent;
    button.innerHTML = "‚è≥";
    button.disabled = true;
    
    try {
        await refreshCurrentHierarchyLevel(true); // force_refresh = true
    } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω–æ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", error);
    }
    
    button.textContent = originalText;
    button.disabled = false;
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–µ—à—É –∫–æ–∂–Ω—ñ 30 —Ö–≤–∏–ª–∏–Ω –¥–ª—è —ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω–æ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
setInterval(async () => {
    try {
        await refreshCurrentHierarchyLevel(false); // –¢–∏—Ö–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –±–µ–∑ force
        console.log("–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω–æ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ");
    } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:", error);
    }
}, 1800000); // 30 —Ö–≤–∏–ª–∏–Ω


// –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —á–∏—Å–µ–ª –∑ —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è–º —Ä–æ–∑—Ä—è–¥—ñ–≤ –ø—Ä–æ–±—ñ–ª–∞–º–∏
function formatNumber(num) {
    if (!num) return "0";
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

function formatDate(dateString) {
    if (!dateString) return "-";
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return "-";
    return date.toLocaleDateString('uk-UA', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
}

// –û—Ç—Ä–∏–º–∞–Ω–Ω—è CSRF —Ç–æ–∫–µ–Ω—É
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ü–æ–∫–∞–∑–∞—Ç–∏/–ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
function showRefreshIndicator() {
    document.querySelector(".auto-refresh-indicator").style.opacity = "1";
}

function hideRefreshIndicator() {
    setTimeout(() => {
        document.querySelector(".auto-refresh-indicator").style.opacity = "0.5";
    }, 1000);
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —Å—É–¥—ñ–≤ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
async function loadCourtsForFilters() {
    try {
        console.log("loadCourtsForFilters –≤–∏–∫–ª–∏–∫–∞–Ω–∞");
        console.log("hierarchyData:", hierarchyData);

        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —ñ—î—Ä–∞—Ä—Ö—ñ—ó
        if (!hierarchyData.year || !hierarchyData.justice_kind || !hierarchyData.instance_code || !hierarchyData.judgment_form) {
            console.log("–ù–µ –≤—Å—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ, –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—É–¥—ñ–≤");
            return; // –ù–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ, —è–∫—â–æ –Ω–µ –≤—Å—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ
        }

        const url = new URL("{% url 'bankruptcy:courts_list_api' %}", window.location.origin);
        url.searchParams.set('year', hierarchyData.year);
        url.searchParams.set('justice_kind', hierarchyData.justice_kind);
        url.searchParams.set('instance_code', hierarchyData.instance_code);
        url.searchParams.set('judgment_code', hierarchyData.judgment_form);

        console.log("–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å—É–¥–∏ –∑ URL:", url.toString());
        const response = await fetch(url);
        const data = await response.json();
        console.log("–û—Ç—Ä–∏–º–∞–Ω–æ –¥–∞–Ω—ñ –ø—Ä–æ —Å—É–¥–∏:", data);

        const courtSelect = document.getElementById('filter-court-main');
        console.log("–ï–ª–µ–º–µ–Ω—Ç filter-court –∑–Ω–∞–π–¥–µ–Ω–æ:", courtSelect);

        if (courtSelect && data && data.courts && data.courts.length > 0) {
            // –û—á–∏—â—É—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ –æ–ø—Ü—ñ—ó (–∑–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ "–í—Å—ñ —Å—É–¥–∏")
            courtSelect.innerHTML = '<option value="">–í—Å—ñ —Å—É–¥–∏</option>';

            // –°—Ç–≤–æ—Ä—é—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ —Å—É–¥—ñ–≤ (–ø–æ court_code)
            const uniqueCourts = [];
            const seenCodes = new Set();

            data.courts.forEach(court => {
                if (!seenCodes.has(court.court_code)) {
                    seenCodes.add(court.court_code);
                    uniqueCourts.push(court);
                }
            });

            console.log("–£–Ω—ñ–∫–∞–ª—å–Ω—ñ —Å—É–¥–∏:", uniqueCourts);

            // –î–æ–¥–∞—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ —Å—É–¥–∏
            uniqueCourts.forEach(court => {
                const option = document.createElement('option');
                option.value = court.court_code;
                option.textContent = court.court_name;
                courtSelect.appendChild(option);
            });

            console.log("–°—É–¥–∏ –¥–æ–¥–∞–Ω–æ –¥–æ select");
        } else {
            console.log("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—É–¥–∏:", {
                courtSelect: !!courtSelect,
                dataExists: !!data,
                courtsExists: !!(data && data.courts),
                courtsLength: data && data.courts ? data.courts.length : 0
            });
        }
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —Å—É–¥—ñ–≤:', error);
        // –ó–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ "–í—Å—ñ —Å—É–¥–∏" –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
        const courtSelect = document.getElementById('filter-court-main');
        if (courtSelect) {
            courtSelect.innerHTML = '<option value="">–í—Å—ñ —Å—É–¥–∏</option>';
        }
    }
}

// –û—á–∏—â–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä–≤–∞–ª—É –ø—Ä–∏ –∑–∞–ª–∏—à–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
window.addEventListener("beforeunload", function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}