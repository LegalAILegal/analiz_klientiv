{% extends "base.html" %}
{% load humanize %}
{% load ukrainian_formatting %}

{% block title %}–°–ø—Ä–∞–≤–∞ ‚Ññ {{ case.number }} - –ê–Ω–∞–ª—ñ–∑ –∫–ª—ñ—î–Ω—Ç—ñ–≤{% endblock %}

{% block extra_head %}
<style>
    /* –°–¢–ò–õ–Ü –¢–û–ß–ù–û –Ø–ö –£ –†–û–ó–ö–õ–ê–î–Ü –ó–ê–°–Ü–î–ê–ù–¨ */
    .decisions-container {
        padding: 10px 20px;
        width: 100%;
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-sizing: border-box;
    }
    
    /* –ß–µ—Ä–µ–¥—É–≤–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä—ñ–≤ –ø—Ä–∏–±—Ä–∞–Ω–æ */
    
    /* WEBKIT –°–ö–†–û–õ –ë–ê–†–ò */
    .table-header-fixed::-webkit-scrollbar,
    .table-body-scrollable::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    .table-header-fixed::-webkit-scrollbar-track,
    .table-body-scrollable::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .table-header-fixed::-webkit-scrollbar-thumb,
    .table-body-scrollable::-webkit-scrollbar-thumb {
        background: #6097ce;
        border-radius: 4px;
    }
    
    .table-header-fixed::-webkit-scrollbar-thumb:hover,
    .table-body-scrollable::-webkit-scrollbar-thumb:hover {
        background: #5088bd;
    }
    
    .decisions-header {
        background: white;
        padding: 20px 40px;
        flex-shrink: 0;
        border-bottom: 1px solid #e0cfc0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .header-info {
        display: flex;
        align-items: center;
        gap: 30px;
    }
    
    .decisions-header h1 {
        color: #131f49;
        font-size: 28px;
        font-weight: bold;
        margin: 0;
        font-family: "FixelDisplay", "Fixel", Arial, sans-serif;
        flex: 1;
    }
    
    .case-info-item {
        background: #f8f9fa;
        padding: 6px 10px;
        border-radius: 5px;
        border: 1px solid #e0cfc0;
        font-size: 12px;
        color: #5b6678;
        white-space: nowrap;
    }
    
    .case-info-item strong {
        color: #131f49;
        font-weight: 600;
    }
    
    /* –ê–î–ê–ü–¢–ò–í–ù–ê –¢–ê–ë–õ–ò–¶–Ø –ù–ê 100% –®–ò–†–ò–ù–ò –ï–ö–†–ê–ù–£ */
    .table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        width: 100%;
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .table-header-fixed {
        background: #131f49;
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
        overflow-y: scroll; /* –ó–ê–í–ñ–î–ò –ü–û–ö–ê–ó–£–Ñ–ú–û –í–ï–†–¢–ò–ö–ê–õ–¨–ù–ò–ô –°–ö–†–û–õ –ë–ê–† –£ –®–ê–ü–¶–Ü */
    }

    .table-body-scrollable {
        flex: 1;
        overflow-y: scroll;
        min-height: 0;
    }

    /* –Ñ–î–ò–ù–ê –¢–ê–ë–õ–ò–¶–Ø –ó –§–Ü–ö–°–û–í–ê–ù–û–Æ –®–ò–†–ò–ù–û–Æ –°–¢–û–í–ë–¶–Ü–í */
    .decisions-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        background: white;
        table-layout: fixed;
        /* –ë–ï–ó min-width - —Ç–∞–±–ª–∏—Ü—è –±—É–¥–µ —Ç–æ—á–Ω–æ –Ω–∞ 100% –≤–∏–¥–∏–º–æ—ó —à–∏—Ä–∏–Ω–∏ */
    }
    
    .decisions-table thead th {
        padding: 12px 8px;
        text-align: center;
        font-weight: bold;
        border-right: 1px solid #6097ce;
        vertical-align: middle;
        background: #131f49;
        color: white;
        position: relative;
        cursor: pointer;
        white-space: normal; /* –î–û–ó–í–û–õ–Ø–Ñ–ú–û –ü–ï–†–ï–ù–ï–°–ï–ù–ù–Ø –¢–ï–ö–°–¢–£ */
        word-wrap: break-word; /* –†–û–ó–ë–ò–í–ê–Ñ–ú–û –î–û–í–ì–Ü –°–õ–û–í–ê */
        line-height: 1.2; /* –ö–û–ú–ü–ê–ö–¢–ù–ò–ô –ú–Ü–ñ–†–Ø–î–ö–û–í–ò–ô –Ü–ù–¢–ï–†–í–ê–õ */
    }
    
    .decisions-table thead th:last-child {
        border-right: none;
    }
    
    .decisions-table tbody td {
        padding: 10px 8px;
        vertical-align: middle; /* –í–ï–†–¢–ò–ö–ê–õ–¨–ù–ï –í–ò–†–Ü–í–ù–Æ–í–ê–ù–ù–Ø –ü–û –¶–ï–ù–¢–†–£ */
        border-right: 1px solid #d3dbe1;
        border-bottom: 1px solid #d3dbe1;
        word-wrap: break-word;
        overflow: hidden;
        text-overflow: ellipsis;
        height: auto;
        min-height: 40px;
        line-height: 1.3;
        text-align: left; /* –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–ï –í–ò–†–Ü–í–ù–Æ–í–ê–ù–ù–Ø –ó–õ–Ü–í–ê */
    }
    
    .decisions-table tbody td:last-child {
        border-right: none;
    }
    
    .decisions-table tbody tr:hover {
        background-color: #e0cfc0;
    }
    
    /* –°–¢–ò–õ–Ü –î–õ–Ø –ö–û–ù–ö–†–ï–¢–ù–ò–• –°–¢–û–í–ë–¶–Ü–í */
    .doc-link, .doc-id-link {
        color: #6097ce;
        text-decoration: none;
        font-weight: bold;
    }
    
    .doc-link:hover, .doc-id-link:hover {
        color: #131f49;
        text-decoration: underline;
    }
    
    .resolution-cell {
        text-align: left;
        vertical-align: top;
        word-wrap: break-word;
        font-size: 11px;
        line-height: 1.3;
        position: relative;
    }
    
    .resolution-text {
        display: -webkit-box;
        -webkit-line-clamp: 7;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        max-height: 9.1em; /* 7 —Ä—è–¥–∫—ñ–≤ * 1.3 line-height */
        line-height: 1.3;
        word-wrap: break-word;
        word-break: break-word;
        hyphens: auto;
        font-size: 11px;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .resolution-text.expanded {
        display: block !important;
        -webkit-line-clamp: unset !important;
        -webkit-box-orient: unset !important;
        max-height: none !important;
        overflow: visible !important;
        text-overflow: unset !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .expand-toggle {
        position: absolute;
        bottom: 2px;
        right: 5px;
        background: #6097ce;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 3px 8px;
        font-size: 10px;
        font-weight: bold;
        cursor: pointer;
        opacity: 0.9;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        z-index: 10;
        min-width: 50px;
        text-align: center;
        display: none; /* –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ */
    }
    
    .expand-toggle:hover {
        opacity: 1;
        background: #5088bd;
        transform: scale(1.05);
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .resolution-cell:hover .expand-toggle {
        opacity: 1;
    }
    
    .expand-toggle.visible {
        display: block !important;
    }
    
    /* –ü–æ–∫—Ä–∞—â–µ–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º—ñ—Å—Ü—è –∫–Ω–æ–ø–∫–∏ */
    .expand-toggle.hidden {
        display: none !important;
    }

    /* –ö–ù–û–ü–ö–ò –¢–ê –ö–û–ù–¢–†–û–õ–ò */
    .header-controls {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-top: 15px;
    }
    
    .decisions-count {
        background: #5b6678;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 12px;
        flex-shrink: 0;
        white-space: nowrap;
    }
    
    /* SR_AI —Å—Ç–∏–ª—ñ –∑–∞–±–∞—Ä–≤–ª–µ–Ω–Ω—è - —Ç–æ—á–Ω–æ —è–∫ —É Excel (–í–ò–ú–ö–ù–ï–ù–û - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–≤–æ–Ω–µ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è) */
    .highlight-viznaty {
        /* –í–ò–ú–ö–ù–ï–ù–û: –ó–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–≤–æ–Ω–µ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –¥–ª—è –∫–æ–º–±—ñ–Ω–∞—Ü—ñ–π */
        /* background-color: #FFFF00 !important; */
        /* color: blue !important; */
    }
    
    /* –ù–û–í–ï: –ß–µ—Ä–≤–æ–Ω–µ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –¥–ª—è –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó "–≤–∏–∑–Ω–∞—Ç–∏" + "–≥—Ä–æ—à–æ–≤—ñ –≤–∏–º–æ–≥–∏" */
    .highlight-critical-combination {
        background-color: #FF0000 !important; /* –ß–ï–†–í–û–ù–ò–ô —Ñ–æ–Ω –¥–ª—è –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó */
        color: white !important;
        font-weight: bold !important;
        border: 2px solid #CC0000 !important; /* –î–æ–¥–∞—Ç–∫–æ–≤–∏–π —á–µ—Ä–≤–æ–Ω–∏–π –±–æ—Ä–¥–µ—Ä –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç—ñ */
    }
    
    /* –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏–π —Å—Ç–∏–ª—å –¥–ª—è —Ç–µ–∫—Å—Ç—É —Ä–µ–∑–æ–ª—é—Ç–∏–≤–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏ */
    .resolution-text.highlight-critical-combination {
        background-color: #FF0000 !important;
        color: white !important;
        font-weight: bold !important;
        padding: 5px !important;
        border-radius: 3px !important;
    }
    
    /* –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏–π —Å—Ç–∏–ª—å –¥–ª—è TD –∫–æ–º—ñ—Ä–∫–∏ */
    td.resolution-cell.highlight-critical-combination {
        background-color: #FF0000 !important;
    }
    
    .highlight-decision {
        background-color: #FFFF00 !important; /* –ñ–æ–≤—Ç–∏–π —Ñ–æ–Ω –¥–ª—è "–ü–æ—Å—Ç–∞–Ω–æ–≤–∞", "–†—ñ—à–µ–Ω–Ω—è", "–°—É–¥–æ–≤–∏–π –Ω–∞–∫–∞–∑" */
    }
    
    /* SR_AI —Å—Ç–∏–ª—ñ –¥–ª—è –≥—ñ–ø–µ—Ä–ø–æ—Å–∏–ª–∞–Ω—å */
    .doc-id-link {
        color: #0000FF !important;
        text-decoration: underline !important;
    }
    
    .doc-id-link:hover {
        color: #800080 !important;
    }
    
    .no-decisions {
        text-align: center;
        padding: 40px;
        color: #5b6678;
        font-style: italic;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url "bankruptcy:index" %}">–ì–æ–ª–æ–≤–Ω–∞</a></li>
                <li class="breadcrumb-item"><a href="{% url "bankruptcy:case_list" %}">–°–ø—Ä–∞–≤–∏</a></li>
                <li class="breadcrumb-item active">–°–ø—Ä–∞–≤–∞ ‚Ññ {{ case.number }}</li>
            </ol>
        </nav>
        
        <h1 class="mb-4">–°–ø—Ä–∞–≤–∞ –ø—Ä–æ –±–∞–Ω–∫—Ä—É—Ç—Å—Ç–≤–æ ‚Ññ {{ case.number }}</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>–î–∞—Ç–∞ –ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è:</strong></td>
                        <td>{{ case.date|date:"d.m.Y" }}</td>
                    </tr>
                    <tr>
                        <td><strong>–ù–æ–º–µ—Ä —Å–ø—Ä–∞–≤–∏:</strong></td>
                        <td>{{ case.case_number }}</td>
                    </tr>
                    <tr>
                        <td><strong>–¢–∏–ø –ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è:</strong></td>
                        <td>{{ case.type }}</td>
                    </tr>
                    <tr>
                        <td><strong>–°—É–¥:</strong></td>
                        <td>{{ case.court.name }}</td>
                    </tr>
                    {% if case.start_date_auc %}
                    <tr>
                        <td><strong>–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É –∞—É–∫—Ü—ñ–æ–Ω—É:</strong></td>
                        <td>{{ case.start_date_auc }}</td>
                    </tr>
                    {% endif %}
                    {% if case.end_date_auc %}
                    <tr>
                        <td><strong>–î–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è –∞—É–∫—Ü—ñ–æ–Ω—É:</strong></td>
                        <td>{{ case.end_date_auc }}</td>
                    </tr>
                    {% endif %}
                    {% if case.end_registration_date %}
                    <tr>
                        <td><strong>–î–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó:</strong></td>
                        <td>{{ case.end_registration_date }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>–ö–æ–¥ –Ñ–î–†–ü–û–£:</strong></td>
                        <td>{{ case.company.edrpou }}</td>
                    </tr>
                    <tr>
                        <td><strong>–ù–∞–∑–≤–∞:</strong></td>
                        <td>{{ case.company.name }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">–°–∏—Å—Ç–µ–º–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>–°—Ç–≤–æ—Ä–µ–Ω–æ:</strong></td>
                        <td>{{ case.created_at|date:"d.m.Y H:i" }}</td>
                    </tr>
                    <tr>
                        <td><strong>–û–Ω–æ–≤–ª–µ–Ω–æ:</strong></td>
                        <td>{{ case.updated_at|date:"d.m.Y H:i" }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- –†–µ—î—Å—Ç—Ä –≤–∏–º–æ–≥ –∫—Ä–µ–¥–∏—Ç–æ—Ä—ñ–≤ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-users"></i> –†–µ—î—Å—Ç—Ä –≤–∏–º–æ–≥ –∫—Ä–µ–¥–∏—Ç–æ—Ä—ñ–≤</h5>
                    <span class="badge badge-light">{{ creditor_claims_count }} –∑–∞–ø–∏—Å—ñ–≤</span>
                </div>
            </div>
            <div class="card-body p-0">
                {% if creditor_claims %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="thead-dark">
                            <tr>
                                <th style="width: 35%;">–ù–∞–∑–≤–∞ –∫—Ä–µ–¥–∏—Ç–æ—Ä–∞</th>
                                <th style="width: 10%;" class="text-center">1-–∞ —á–µ—Ä–≥–∞</th>
                                <th style="width: 10%;" class="text-center">2-–∞ —á–µ—Ä–≥–∞</th>
                                <th style="width: 10%;" class="text-center">3-—è —á–µ—Ä–≥–∞</th>
                                <th style="width: 10%;" class="text-center">4-–∞ —á–µ—Ä–≥–∞</th>
                                <th style="width: 10%;" class="text-center">5-–∞ —á–µ—Ä–≥–∞</th>
                                <th style="width: 10%;" class="text-center">6-–∞ —á–µ—Ä–≥–∞</th>
                                <th style="width: 5%;" class="text-center">–î–æ—Å—Ç–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for claim in creditor_claims %}
                            <tr>
                                <td><strong style="color: black;">{{ claim.creditor.name }}</strong></td>
                                <td class="text-right">
                                    {% if claim.amount_1st_queue and claim.amount_1st_queue > 0 %}
                                        <span style="color: black; font-weight: bold;">{{ claim.amount_1st_queue|ukrainian_currency }}</span>
                                    {% else %}
                                        <span style="color: black;">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-right">
                                    {% if claim.amount_2nd_queue and claim.amount_2nd_queue > 0 %}
                                        <span style="color: black; font-weight: bold;">{{ claim.amount_2nd_queue|ukrainian_currency }}</span>
                                    {% else %}
                                        <span style="color: black;">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-right">
                                    {% if claim.amount_3rd_queue and claim.amount_3rd_queue > 0 %}
                                        <span style="color: black; font-weight: bold;">{{ claim.amount_3rd_queue|ukrainian_currency }}</span>
                                    {% else %}
                                        <span style="color: black;">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-right">
                                    {% if claim.amount_4th_queue and claim.amount_4th_queue > 0 %}
                                        <span style="color: black; font-weight: bold;">{{ claim.amount_4th_queue|ukrainian_currency }}</span>
                                    {% else %}
                                        <span style="color: black;">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-right">
                                    {% if claim.amount_5th_queue and claim.amount_5th_queue > 0 %}
                                        <span style="color: black; font-weight: bold;">{{ claim.amount_5th_queue|ukrainian_currency }}</span>
                                    {% else %}
                                        <span style="color: black;">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-right">
                                    {% if claim.amount_6th_queue and claim.amount_6th_queue > 0 %}
                                        <span style="color: black; font-weight: bold;">{{ claim.amount_6th_queue|ukrainian_currency }}</span>
                                    {% else %}
                                        <span style="color: black;">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if claim.confidence_score %}
                                        <span class="badge {% if claim.confidence_score >= 0.8 %}badge-success{% elif claim.confidence_score >= 0.6 %}badge-warning{% else %}badge-danger{% endif %}" style="color: black;">
                                            {{ claim.confidence_score|floatformat:2 }}
                                        </span>
                                    {% else %}
                                        <span style="color: black;">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
                    </div>
                    <h5>–î–∞–Ω—ñ –∫—Ä–µ–¥–∏—Ç–æ—Ä—ñ–≤ —â–µ –Ω–µ –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ</h5>
                    <p class="text-muted">–ó–∞–ø—É—Å—Ç—ñ—Ç—å –∞–Ω–∞–ª—ñ–∑ –º–æ–≤–Ω–æ—é –º–æ–¥–µ–ª–ª—é –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –∫—Ä–µ–¥–∏—Ç–æ—Ä—ñ–≤ –∑ —Ä–µ–∑–æ–ª—é—Ç–∏–≤–Ω–∏—Ö —á–∞—Å—Ç–∏–Ω.</p>
                    <div class="alert alert-info">
                        <code>python manage.py analyze_creditors_llm --start-case {{ case.number }} --limit 1</code>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –°—É–¥–æ–≤—ñ —Ä—ñ—à–µ–Ω–Ω—è –≤ —Å—Ç–∏–ª—ñ –µ—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ –ø—Ä–æ—î–∫—Ç—É -->
<div class="decisions-container">
    
    <div class="decisions-header">
        <div class="header-title-row">
            <h1>–°—É–¥–æ–≤—ñ —Ä—ñ—à–µ–Ω–Ω—è –ø–æ —Å–ø—Ä–∞–≤—ñ {{ case.case_number }}</h1>
            <div class="header-info">
                <div class="case-info-item">
                    <strong>–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ:</strong> {{ case.company.name|truncatechars:30 }}
                </div>
                <div class="case-info-item">
                    <strong>–Ñ–î–†–ü–û–£:</strong> {{ case.company.edrpou }}
                </div>
                <div class="decisions-count">{{ decisions_count }} –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤</div>
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç—É—Å –ø–æ—à—É–∫—É -->
        {% if is_tracked %}
        <div class="header-controls">
            <div class="case-info-item">
                <strong>–°—Ç–∞—Ç—É—Å –ø–æ—à—É–∫—É:</strong>
                {% if search_status == "pending" %}
                    <span style="color: #ffc107;">–û—á—ñ–∫—É—î</span>
                {% elif search_status == "starting" %}
                    <span style="color: #17a2b8;">–ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è</span>
                {% elif search_status == "running" %}
                    <span style="color: #007bff;">–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è</span>
                {% elif search_status == "completed" %}
                    <span style="color: #28a745;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                {% elif search_status == "failed" %}
                    <span style="color: #dc3545;">–ü–æ–º–∏–ª–∫–∞</span>
                {% endif %}
            </div>
            <button class="decisions-count" onclick="location.reload();" title="–û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å" style="cursor: pointer; border: none;">
                üîÑ –û–Ω–æ–≤–∏—Ç–∏
            </button>
        </div>
        {% endif %}
    </div>
    
    {% if court_decisions %}
    
    <!-- –¢–ê–ë–õ–ò–¶–Ø –ù–ê 100% –®–ò–†–ò–ù–ò –ó –£–°–Ü–ú–ê –°–¢–û–í–ë–¶–Ø–ú–ò -->
    <div class="table-container">
        <!-- –§—ñ–∫—Å–æ–≤–∞–Ω–∞ —à–∞–ø–∫–∞ -->
        <div class="table-header-fixed">
            <table class="decisions-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">ID –¥–æ–∫—É–º–µ–Ω—Ç–∞</th>
                        <th style="width: 10%;">–ù–∞–∑–≤–∞ —Å—É–¥—É</th>
                        <th style="width: 8%;">–í–∏–¥ —Ä—ñ—à–µ–Ω–Ω—è</th>
                        <th style="width: 8%;">–í–∏–¥ —Å—É–¥–æ—á–∏–Ω—Å—Ç–≤–∞</th>
                        <th style="width: 8%;">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è —Å–ø—Ä–∞–≤–∏</th>
                        <th style="width: 8%;">–ù–æ–º–µ—Ä —Å–ø—Ä–∞–≤–∏</th>
                        <th style="width: 5%;">–î–∞—Ç–∞ —É—Ö–≤–∞–ª–µ–Ω–Ω—è</th>
                        <th style="width: 8%;">–°—É–¥–¥—è</th>
                        <th style="width: 5%;">–ü–æ—Å–∏–ª–∞–Ω–Ω—è</th>
                        <th style="width: 35%;">–†–µ–∑–æ–ª—é—Ç–∏–≤–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞</th>
                    </tr>
                </thead>
            </table>
        </div>

        <!-- –°–∫—Ä–æ–ª—é–≤–∞–ª—å–Ω–µ —Ç—ñ–ª–æ —Ç–∞–±–ª–∏—Ü—ñ -->
        <div class="table-body-scrollable">
            <table class="decisions-table">
                <tbody>
                    {% for decision in court_decisions %}
                    <tr class="decision-row">
                        <td style="width: 5%;">
                            {% if decision.doc_id and decision.doc_id != "nan" %}
                                <a href="https://reyestr.court.gov.ua/Review/{{ decision.doc_id }}" 
                                   target="_blank" class="doc-id-link">{{ decision.doc_id }}</a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td style="width: 10%;">{{ decision.court_name|default:"-" }}</td>
                        <td style="width: 8%;" class="{% if "–ü–æ—Å—Ç–∞–Ω–æ–≤–∞" in decision.judgment_name or "–†—ñ—à–µ–Ω–Ω—è" in decision.judgment_name or "–°—É–¥–æ–≤–∏–π –Ω–∞–∫–∞–∑" in decision.judgment_name %}highlight-decision{% endif %}">
                            {{ decision.judgment_name|default:"-" }}
                        </td>
                        <td style="width: 8%;">{{ decision.justice_kind_name|default:"-" }}</td>
                        <td style="width: 8%;">{{ decision.category_name|default:"-" }}</td>
                        <td style="width: 8%;"><strong>{{ decision.cause_num|default:"-" }}</strong></td>
                        <td style="width: 5%;">{{ decision.adjudication_date|default:"-" }}</td>
                        <td style="width: 8%;">{{ decision.judge|default:"-" }}</td>
                        <td style="width: 5%;">
                            {% if decision.doc_url and decision.doc_url != "nan" %}
                                <a href="{{ decision.doc_url }}" target="_blank" class="doc-link">{{ decision.doc_url|truncatechars:8 }}</a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td style="width: 35%; {% if decision.should_highlight_red %}background-color: #FF0000 !important;{% endif %}" class="resolution-cell {% if decision.should_highlight_red %}highlight-critical-combination{% endif %}">
                            {% if decision.resolution_text and decision.resolution_text != "-" and decision.resolution_text != "–†–µ–∑–æ–ª—é—Ç–∏–≤–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞" and decision.resolution_text != "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç" %}
                                <div class="resolution-text {% if decision.should_highlight_red %}highlight-critical-combination{% endif %}" 
                                     style="{% if decision.should_highlight_red %}background-color: #FF0000 !important; color: white !important; font-weight: bold !important; padding: 5px; border-radius: 3px;{% endif %}" 
                                     id="resolution-{{ forloop.counter }}">
                                    {{ decision.resolution_text }}
                                </div>
                                <button class="expand-toggle" id="toggle-{{ forloop.counter }}" onclick="toggleResolution({{ forloop.counter }})">
                                    –ë—ñ–ª—å—à–µ
                                </button>
                            {% elif decision.doc_url and decision.doc_url != "nan" %}
                                <span style="color: #ffc107;">–û—á—ñ–∫—É—î –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    {% else %}
    <div class="no-decisions">
        <h3>–°—É–¥–æ–≤—ñ —Ä—ñ—à–µ–Ω–Ω—è —â–µ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</h3>
        <p>–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–≤–∂—É—î –ø–æ—à—É–∫ —Å—É–¥–æ–≤–∏—Ö —Ä—ñ—à–µ–Ω—å –ø–æ —Å–ø—Ä–∞–≤—ñ {{ case.case_number }}.<br>
           –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑"—è–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø–æ—à—É–∫—É –≤ –±–∞–∑–∞—Ö –¥–∞–Ω–∏—Ö.</p>
    </div>
    {% endif %}
</div>

<div class="row mt-4">
    <div class="col-12">
        <a href="{% url "bankruptcy:case_list" %}" class="btn btn-secondary">‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Å–ø–∏—Å–∫—É</a>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è/–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —Ä–µ–∑–æ–ª—é—Ç–∏–≤–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏
function toggleResolution(id) {
    console.log(`=== TOGGLE RESOLUTION ===`);
    console.log(`Input ID: ${id}, Type: ${typeof id}`);
    
    const resolutionText = document.getElementById(`resolution-${id}`);
    const toggleBtn = document.getElementById(`toggle-${id}`);
    
    console.log(`Found resolutionText: ${!!resolutionText}, toggleBtn: ${!!toggleBtn}`);
    
    if (!resolutionText || !toggleBtn) {
        console.log(`Elements not found for ID: ${id}`);
        return;
    }
    
    const isExpanded = resolutionText.classList.contains("expanded");
    console.log(`Current state - expanded: ${isExpanded}`);
    
    if (isExpanded) {
        // –ó–≥–æ—Ä—Ç–∞—î–º–æ - –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ truncated —Å—Ç–∏–ª—ñ
        resolutionText.classList.remove("expanded");
        resolutionText.style.display = "-webkit-box";
        resolutionText.style.webkitLineClamp = "7";
        resolutionText.style.webkitBoxOrient = "vertical";
        resolutionText.style.overflow = "hidden";
        resolutionText.style.textOverflow = "ellipsis";
        resolutionText.style.maxHeight = "9.1em";
        toggleBtn.textContent = "–ë—ñ–ª—å—à–µ";
        console.log(`Collapsed text for ID: ${id}`);
    } else {
        // –†–æ–∑–≥–æ—Ä—Ç–∞—î–º–æ - –ø—Ä–∏–±–∏—Ä–∞—î–º–æ truncation
        resolutionText.classList.add("expanded");
        resolutionText.style.display = "block";
        resolutionText.style.webkitLineClamp = "unset";
        resolutionText.style.webkitBoxOrient = "unset";
        resolutionText.style.overflow = "visible";
        resolutionText.style.textOverflow = "unset";
        resolutionText.style.maxHeight = "none";
        toggleBtn.textContent = "–ú–µ–Ω—à–µ";
        console.log(`Expanded text for ID: ${id}`);
    }
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É –∫–Ω–æ–ø–æ–∫ —Ç—ñ–ª—å–∫–∏ —Ç–∞–º, –¥–µ —Ç–µ–∫—Å—Ç –¥–æ–≤–≥–∏–π
function showNecessaryToggleButtons() {
    console.log("=== –ü–ï–†–ï–í–Ü–†–ö–ê –ö–ù–û–ü–û–ö –†–û–ó–ì–û–†–¢–ê–ù–ù–Ø ===");
    
    document.querySelectorAll(".resolution-text").forEach((element, index) => {
        const elementId = element.id;
        const toggleBtnId = elementId.replace("resolution-", "toggle-");
        const toggleBtn = document.getElementById(toggleBtnId);
        
        if (!toggleBtn) {
            console.log(`–ö–Ω–æ–ø–∫–∞ ${toggleBtnId} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –µ–ª–µ–º–µ–Ω—Ç–∞ ${elementId}`);
            return;
        }
        
        // –û—Ç—Ä–∏–º—É—î–º–æ —Ç–µ–∫—Å—Ç–æ–≤–∏–π –≤–º—ñ—Å—Ç
        const textContent = element.textContent || element.innerText || "";
        const textLength = textContent.trim().length;
        
        console.log(`–ï–ª–µ–º–µ–Ω—Ç ${elementId}: –¥–æ–≤–∂–∏–Ω–∞ —Ç–µ–∫—Å—Ç—É = ${textLength} —Å–∏–º–≤–æ–ª—ñ–≤`);
        
        // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ truncation —Å—Ç–∏–ª—ñ
        element.style.display = "-webkit-box";
        element.style.webkitLineClamp = "7";
        element.style.webkitBoxOrient = "vertical";
        element.style.overflow = "hidden";
        element.style.textOverflow = "ellipsis";
        element.style.maxHeight = "9.1em";
        element.style.lineHeight = "1.3";
        
        // –ü—Ä–æ—Å—Ç—ñ—à–∏–π –ø—ñ–¥—Ö—ñ–¥ - –ø–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –¥–ª—è —Ç–µ–∫—Å—Ç—É –¥–æ–≤—à–µ 300 —Å–∏–º–≤–æ–ª—ñ–≤
        if (textLength > 300) {
            toggleBtn.style.display = "block";
            toggleBtn.classList.add("visible");
            console.log(`–ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –¥–ª—è ${elementId} (–¥–æ–≤–∂–∏–Ω–∞: ${textLength})`);
        } else {
            console.log(`–ö–Ω–æ–ø–∫–∞ –¥–ª—è ${elementId} –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ—é (–¥–æ–≤–∂–∏–Ω–∞: ${textLength})`);
        }
    });
}

// –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener("DOMContentLoaded", function() {
    console.log("=== DOM LOADED ===");
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å–∫—ñ–ª—å–∫–∏ —Ä–µ–∑–æ–ª—é—Ç–∏–≤–Ω–∏—Ö —Ç–µ–∫—Å—Ç—ñ–≤ —î –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
    const allResolutionTexts = document.querySelectorAll(".resolution-text");
    console.log(`–ó–Ω–∞–π–¥–µ–Ω–æ ${allResolutionTexts.length} —Ä–µ–∑–æ–ª—é—Ç–∏–≤–Ω–∏—Ö —Ç–µ–∫—Å—Ç—ñ–≤`);
    
    allResolutionTexts.forEach((el, index) => {
        console.log(`${index + 1}. ID: ${el.id}, –¥–æ–≤–∂–∏–Ω–∞ —Ç–µ–∫—Å—Ç—É: ${(el.textContent || "").length} —Å–∏–º–≤–æ–ª—ñ–≤`);
    });
    
    const allToggleButtons = document.querySelectorAll(".expand-toggle");
    console.log(`–ó–Ω–∞–π–¥–µ–Ω–æ ${allToggleButtons.length} –∫–Ω–æ–ø–æ–∫ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è`);
    
    setTimeout(() => {
        showNecessaryToggleButtons();
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∫–Ω–æ–ø–∫–∏ —Å—Ç–≤–æ—Ä–∏–ª–∏—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
        setTimeout(() => {
            const visibleButtons = document.querySelectorAll(".expand-toggle.visible");
            console.log(`–í–∏–¥–∏–º–∏—Ö –∫–Ω–æ–ø–æ–∫ –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: ${visibleButtons.length}`);
            
            visibleButtons.forEach((btn, index) => {
                console.log(`–ö–Ω–æ–ø–∫–∞ ${index + 1}: ID=${btn.id}, —Ç–µ–∫—Å—Ç="${btn.textContent}"`);
            });
            
            // –¢–µ—Å—Ç—É—î–º–æ –ø–µ—Ä—à—É –≤–∏–¥–∏–º—É –∫–Ω–æ–ø–∫—É
            if (visibleButtons.length > 0) {
                console.log("=== –¢–ï–°–¢ –ü–ï–†–®–û–á –ö–ù–û–ü–ö–ò ===");
                const firstBtn = visibleButtons[0];
                console.log(`–¢–µ—Å—Ç—É—î–º–æ –∫–Ω–æ–ø–∫—É: ${firstBtn.id}`);
                
                // –°–∏–º—É–ª—é—î–º–æ –∫–ª—ñ–∫ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏
                setTimeout(() => {
                    console.log("–°–∏–º—É–ª—é—é –∫–ª—ñ–∫ –ø–æ –∫–Ω–æ–ø—Ü—ñ...");
                    firstBtn.click();
                }, 2000);
            }
        }, 500);
    }, 300);
});

// –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–Ø –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–û–ì–û –°–ö–†–û–õ–£ –ú–Ü–ñ –®–ê–ü–ö–û–Æ –¢–ê –¢–Ü–õ–û–ú –¢–ê–ë–õ–ò–¶–Ü
function initTableScrollSync() {
    const headerScroll = document.querySelector(".table-header-fixed");
    const bodyScroll = document.querySelector(".table-body-scrollable");
    
    if (headerScroll && bodyScroll) {
        // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Å–∫—Ä–æ–ª—É –≤—ñ–¥ —à–∞–ø–∫–∏ –¥–æ —Ç—ñ–ª–∞
        headerScroll.addEventListener("scroll", function() {
            if (bodyScroll.scrollLeft !== headerScroll.scrollLeft) {
                bodyScroll.scrollLeft = headerScroll.scrollLeft;
            }
        });
        
        // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Å–∫—Ä–æ–ª—É –≤—ñ–¥ —Ç—ñ–ª–∞ –¥–æ —à–∞–ø–∫–∏
        bodyScroll.addEventListener("scroll", function() {
            if (headerScroll.scrollLeft !== bodyScroll.scrollLeft) {
                headerScroll.scrollLeft = bodyScroll.scrollLeft;
            }
        });
    }
}

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é —Å–∫—Ä–æ–ª—É
document.addEventListener("DOMContentLoaded", initTableScrollSync);
</script>
{% endblock %}