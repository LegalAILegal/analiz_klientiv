{% extends "bankruptcy/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–Ω–∏–º–∏ –ø—Ä–æ—Ü–µ—Å–∞–º–∏{% endblock %}

{% block extra_css %}
<style>
.control-panel {
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
}

.process-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    overflow: hidden;
}

.process-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.process-title {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
}

.status-idle { background: #e3f2fd; color: #1976d2; }
.status-running { background: #e8f5e8; color: #388e3c; }
.status-forced_running { background: #fff3e0; color: #f57c00; }
.status-paused { background: #fce4ec; color: #c2185b; }
.status-error { background: #ffebee; color: #d32f2f; }

.process-content {
    padding: 20px;
}

.process-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.info-item {
    display: flex;
    flex-direction: column;
}

.info-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
    text-transform: uppercase;
}

.info-value {
    font-size: 14px;
    font-weight: 500;
}

.progress-bar {
    background: #f0f0f0;
    border-radius: 10px;
    height: 8px;
    overflow: hidden;
    margin: 10px 0;
}

.progress-fill {
    background: linear-gradient(90deg, #4caf50, #81c784);
    height: 100%;
    transition: width 0.3s ease;
}

.process-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: #1976d2;
    color: white;
}

.btn-primary:hover {
    background: #1565c0;
}

.btn-danger {
    background: #d32f2f;
    color: white;
}

.btn-danger:hover {
    background: #c62828;
}

.btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.alert {
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.alert-info {
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    color: #1976d2;
}

.alert-warning {
    background: #fff3e0;
    border: 1px solid #ffcc80;
    color: #f57c00;
}

.alert-success {
    background: #e8f5e8;
    border: 1px solid #a5d6a7;
    color: #388e3c;
}

.alert-error {
    background: #ffebee;
    border: 1px solid #ffcdd2;
    color: #d32f2f;
}

.last-message {
    background: #f9f9f9;
    border-left: 4px solid #2196f3;
    padding: 10px 15px;
    margin-top: 15px;
    font-size: 14px;
    border-radius: 0 4px 4px 0;
}

.auto-refresh {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}

.system-status {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
    text-align: center;
}

.forced-process-banner {
    background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
    font-weight: 500;
}

.statistics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 20px;
    text-align: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.stat-number {
    font-size: 32px;
    font-weight: 700;
    color: #1976d2;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 14px;
    color: #666;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-description {
    font-size: 12px;
    color: #999;
    margin-top: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="control-panel">
    <h1 class="text-center mb-4">üéõÔ∏è –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–Ω–∏–º–∏ –ø—Ä–æ—Ü–µ—Å–∞–º–∏</h1>
    
    <!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º–∏ -->
    {% if is_any_forced %}
    <div class="forced-process-banner">
        ‚ö° –£–í–ê–ì–ê: –ê–∫—Ç–∏–≤–Ω–∏–π –ø—Ä–∏–º—É—Å–æ–≤–∏–π –ø—Ä–æ—Ü–µ—Å "{{ forced_process.get_process_type_display }}"
        <br>–í—Å—ñ —ñ–Ω—à—ñ –ø—Ä–æ—Ü–µ—Å–∏ –ø—Ä–∏–∑—É–ø–∏–Ω–µ–Ω—ñ
    </div>
    {% else %}
    <div class="system-status">
        ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞—Ü—é—î –≤ —à—Ç–∞—Ç–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ
    </div>
    {% endif %}
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º–∏ -->
    <div class="statistics-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_cases|floatformat:0 }}</div>
            <div class="stat-label">–í—Å—å–æ–≥–æ —Å–ø—Ä–∞–≤</div>
            <div class="stat-description">–°–ø—Ä–∞–≤–∏ –ø—Ä–æ –±–∞–Ω–∫—Ä—É—Ç—Å—Ç–≤–æ</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ stats.tracked_cases|floatformat:0 }}</div>
            <div class="stat-label">–í—ñ–¥—Å—Ç–µ–∂—É—é—Ç—å—Å—è</div>
            <div class="stat-description">–°–ø—Ä–∞–≤–∏ –≤ –æ–±—Ä–æ–±—Ü—ñ —Å–∏—Å—Ç–µ–º–æ—é</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ stats.untracked_cases|floatformat:0 }}</div>
            <div class="stat-label">–ù–µ –≤—ñ–¥—Å—Ç–µ–∂—É—é—Ç—å—Å—è</div>
            <div class="stat-description">–°–ø—Ä–∞–≤–∏ –ø–æ–∑–∞ –æ–±—Ä–æ–±–∫–æ—é</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_decisions|floatformat:0 }}</div>
            <div class="stat-label">–°—É–¥–æ–≤—ñ —Ä—ñ—à–µ–Ω–Ω—è</div>
            <div class="stat-description">–í—Å—å–æ–≥–æ —Ä—ñ—à–µ–Ω—å –≤ –ë–î</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ stats.decisions_with_resolutions|floatformat:0 }}</div>
            <div class="stat-label">–ó —Ä–µ–∑–æ–ª—é—Ç–∏–≤–Ω–∏–º–∏</div>
            <div class="stat-description">–†—ñ—à–µ–Ω–Ω—è –∑ –≤–∏—Ç—è–≥–Ω—É—Ç–∏–º —Ç–µ–∫—Å—Ç–æ–º</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ stats.decisions_without_resolutions|floatformat:0 }}</div>
            <div class="stat-label">–ë–µ–∑ —Ä–µ–∑–æ–ª—é—Ç–∏–≤–Ω–∏—Ö</div>
            <div class="stat-description">–†—ñ—à–µ–Ω–Ω—è –±–µ–∑ –≤–∏—Ç—è–≥–Ω—É—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç—É</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ stats.extraction_percentage|floatformat:1 }}%</div>
            <div class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è</div>
            <div class="stat-description">–í—ñ–¥—Å–æ—Ç–æ–∫ –æ–±—Ä–æ–±–ª–µ–Ω–∏—Ö —Ä—ñ—à–µ–Ω—å</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ stats.decisions_with_triggers|floatformat:0 }}</div>
            <div class="stat-label">–ó —Ç—Ä–∏–≥–µ—Ä–∞–º–∏</div>
            <div class="stat-description">–†—ñ—à–µ–Ω–Ω—è –∑—ñ —Å–ª–æ–≤–æ–º "–≤–∏–∑–Ω–∞—Ç–∏"</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ stats.decisions_without_rtf|floatformat:0 }}</div>
            <div class="stat-label">–ë–µ–∑ RTF —Ñ–∞–π–ª—ñ–≤</div>
            <div class="stat-description">–†—ñ—à–µ–Ω–Ω—è –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ stats.recent_extractions|floatformat:0 }}</div>
            <div class="stat-label">–ó–∞ –¥–æ–±—É</div>
            <div class="stat-description">–í–∏—Ç—è–≥–Ω—É—Ç–æ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 24 –≥–æ–¥–∏–Ω–∏</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ stats.trigger_percentage|floatformat:1 }}%</div>
            <div class="stat-label">–¢—Ä–∏–≥–µ—Ä-—Å–ª–æ–≤–∞</div>
            <div class="stat-description">–í—ñ–¥—Å–æ—Ç–æ–∫ —Ä—ñ—à–µ–Ω—å –∑—ñ —Å–ª–æ–≤–æ–º "–≤–∏–∑–Ω–∞—Ç–∏"</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ stats.extraction_speed|floatformat:0 }}</div>
            <div class="stat-label">–®–≤–∏–¥–∫—ñ—Å—Ç—å/–≥–æ–¥</div>
            <div class="stat-description">–°–µ—Ä–µ–¥–Ω—è —à–≤–∏–¥–∫—ñ—Å—Ç—å –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è</div>
        </div>
    </div>
    
    <!-- –î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è -->
    <div class="process-card" style="margin-bottom: 30px;">
        <div class="process-header">
            <h3 class="process-title">üìä –î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è —Ä–µ–∑–æ–ª—é—Ç–∏–≤–Ω–∏—Ö —á–∞—Å—Ç–∏–Ω</h3>
            <button class="btn btn-primary" onclick="refreshExtractionDetails()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
        </div>
        
        <div class="process-content">
            <div id="extraction-details">
                <div class="process-info">
                    <div class="info-item">
                        <div class="info-label">–ï—Ç–∞–ø–∏ –æ–±—Ä–æ–±–∫–∏</div>
                        <div class="info-value" id="extraction-stages">
                            üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: {{ stats.decisions_with_rtf|floatformat:0 }} —Ä—ñ—à–µ–Ω—å<br>
                            üîç –ê–Ω–∞–ª—ñ–∑: {{ stats.decisions_with_resolutions|floatformat:0 }} –æ–±—Ä–æ–±–ª–µ–Ω–∏—Ö<br>
                            ‚úÖ –¢—Ä–∏–≥–µ—Ä-—Å–ª–æ–≤–∞: {{ stats.decisions_with_triggers|floatformat:0 }} –∑–Ω–∞–π–¥–µ–Ω–æ<br>
                            ‚è≥ –ó–∞–ª–∏—à–∏–ª–æ—Å—å: {{ stats.decisions_without_resolutions|floatformat:0 }} —Ä—ñ—à–µ–Ω—å
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</div>
                        <div class="info-value" id="extraction-efficiency">
                            üìà –ü—Ä–æ–≥—Ä–µ—Å: {{ stats.extraction_percentage|floatformat:1 }}%<br>
                            üéØ –¢—Ä–∏–≥–µ—Ä-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω—ñ—Å—Ç—å: {{ stats.trigger_percentage|floatformat:1 }}%<br>
                            üíæ RTF –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å: {{ stats.rtf_availability_percentage|floatformat:1 }}%<br>
                            ‚ö° –®–≤–∏–¥–∫—ñ—Å—Ç—å: {{ stats.extraction_speed|floatformat:0 }} —Ä—ñ—à–µ–Ω—å/–≥–æ–¥
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">–¢–µ–Ω–¥–µ–Ω—Ü—ñ—ó</div>
                        <div class="info-value" id="extraction-trends">
                            üìÖ –ó–∞ —Å—å–æ–≥–æ–¥–Ω—ñ: {{ stats.today_extractions|floatformat:0 }} —Ä—ñ—à–µ–Ω—å<br>
                            üìä –ó–∞ —Ç–∏–∂–¥–µ–Ω—å: {{ stats.week_extractions|floatformat:0 }} —Ä—ñ—à–µ–Ω—å<br>
                            üìà –ó–∞ –º—ñ—Å—è—Ü—å: {{ stats.month_extractions|floatformat:0 }} —Ä—ñ—à–µ–Ω—å<br>
                            üî• –ü—ñ–∫–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å: {{ stats.peak_extraction_hour|floatformat:0 }}:00
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">–Ø–∫—ñ—Å—Ç—å –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è</div>
                        <div class="info-value" id="extraction-quality">
                            ‚úÖ –£—Å–ø—ñ—à–Ω—ñ: {{ stats.successful_extractions|floatformat:0 }} —Ä—ñ—à–µ–Ω—å<br>
                            ‚ùå –ü–æ–º–∏–ª–∫–∏: {{ stats.failed_extractions|floatformat:0 }} —Ä—ñ—à–µ–Ω—å<br>
                            üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞ –æ–±—Ä–æ–±–∫–∞: {{ stats.retry_extractions|floatformat:0 }} —Ä—ñ—à–µ–Ω—å<br>
                            üìè –°–µ—Ä–µ–¥–Ω—è –¥–æ–≤–∂–∏–Ω–∞: {{ stats.avg_resolution_length|floatformat:0 }} —Å–∏–º–≤–æ–ª—ñ–≤
                        </div>
                    </div>
                </div>
                
                <!-- –ü—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è -->
                <div class="progress-bar" style="margin-top: 20px;">
                    <div class="progress-fill" style="width: {{ stats.extraction_percentage }}%; background: linear-gradient(90deg, #2196f3, #21cbf3);"></div>
                </div>
                <div style="text-align: center; margin-top: 10px; font-size: 14px; color: #666;">
                    –ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è: {{ stats.extraction_percentage|floatformat:1 }}%
                </div>
                
                <!-- –ú–∏–Ω–∏-–≥—Ä–∞—Ñ—ñ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ –≥–æ–¥–∏–Ω–∏ -->
                <div style="margin-top: 20px;">
                    <div class="info-label" style="margin-bottom: 10px;">–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 24 –≥–æ–¥–∏–Ω–∏</div>
                    <div id="extraction-activity-chart" style="height: 60px; background: linear-gradient(90deg, #f0f0f0 0%, #e3f2fd 50%, #f0f0f0 100%); border-radius: 4px; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; font-size: 12px;">
                            üìä {{ stats.recent_extractions|floatformat:0 }} –≤–∏—Ç—è–≥—É–≤–∞–Ω—å –∑–∞ 24 –≥–æ–¥–∏–Ω–∏
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è -->
    <div class="auto-refresh">
        <label>
            <input type="checkbox" id="auto-refresh" checked> –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è (5 —Å–µ–∫)
        </label>
        <button class="btn btn-primary" onclick="refreshStatus()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –∑–∞—Ä–∞–∑</button>
    </div>
    
    <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
    <div id="message-container"></div>
    
    <!-- –ü—Ä–æ—Ü–µ—Å–∏ -->
    <div id="processes-container">
        {% for process in processes %}
        <div class="process-card" data-process-id="{{ process.id }}">
            <div class="process-header">
                <h3 class="process-title">{{ process.get_process_type_display }}</h3>
                <span class="status-badge status-{{ process.status }}">
                    {{ process.get_status_display }}
                    {% if process.is_forced %}‚ö°{% endif %}
                </span>
            </div>
            
            <div class="process-content">
                <div class="process-info">
                    <div class="info-item">
                        <div class="info-label">–ü—Ä–æ–≥—Ä–µ—Å</div>
                        <div class="info-value">
                            {{ process.progress_current }} / {{ process.progress_total }}
                            {% if process.progress_total > 0 %}
                                ({{ process.progress_percentage|floatformat:1 }}%)
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">–ó–∞–ø—É—â–µ–Ω–æ</div>
                        <div class="info-value">
                            {% if process.started_at %}
                                {{ process.started_at|date:"H:i:s d.m.Y" }}
                            {% else %}
                                –ù–µ –∑–∞–ø—É—â–µ–Ω–æ
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">–û–Ω–æ–≤–ª–µ–Ω–æ</div>
                        <div class="info-value">{{ process.updated_at|date:"H:i:s d.m.Y" }}</div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">–†–µ–∂–∏–º</div>
                        <div class="info-value">
                            {% if process.is_forced %}
                                ‚ö° –ü—Ä–∏–º—É—Å–æ–≤–∏–π
                            {% else %}
                                üìã –®—Ç–∞—Ç–Ω–∏–π
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- –ü—Ä–æ–≥—Ä–µ—Å –±–∞—Ä -->
                {% if process.progress_total > 0 %}
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ process.progress_percentage }}%"></div>
                </div>
                {% endif %}
                
                <!-- –û—Å—Ç–∞–Ω–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
                {% if process.last_message %}
                <div class="last-message">
                    üìù {{ process.last_message }}
                </div>
                {% endif %}
                
                <!-- –î—ñ—ó -->
                <div class="process-actions">
                    {% if process.process_type == "court_search" %}
                        <button class="btn btn-primary start-process-btn" 
                                data-process-type="court_search"
                                {% if is_any_forced %}disabled{% endif %}>
                            üîç –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–æ—à—É–∫ —Ä—ñ—à–µ–Ω—å
                        </button>
                    {% elif process.process_type == "resolution_extraction" %}
                        <button class="btn btn-primary start-process-btn" 
                                data-process-type="resolution_extraction"
                                {% if is_any_forced %}disabled{% endif %}>
                            üìÑ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–æ–≤–Ω–µ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è
                        </button>
                        
                        <button class="btn btn-secondary" 
                                onclick="startIncrementalExtraction()"
                                {% if is_any_forced %}disabled{% endif %}>
                            ‚ö° –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–µ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è
                        </button>
                        
                        <button class="btn btn-info" 
                                onclick="startSmallBatchExtraction()"
                                {% if is_any_forced %}disabled{% endif %}>
                            üîß –¢–µ—Å—Ç–æ–≤–µ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è (10 —Ä—ñ—à–µ–Ω—å)
                        </button>
                        
                        <button class="btn btn-warning" 
                                onclick="startUltraFastExtraction()"
                                {% if is_any_forced %}disabled{% endif %}
                                style="background: linear-gradient(45deg, #ff6b35, #ff8e53); border: none; font-weight: bold;">
                            üöÄ –£–õ–¨–¢–†–ê-–®–í–ò–î–ö–ò–ô –†–ï–ñ–ò–ú
                        </button>
                    {% endif %}
                    
                    {% if process.is_forced %}
                        <button class="btn btn-danger stop-process-btn">
                            ‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏ –ø—Ä–∏–º—É—Å–æ–≤–∏–π –ø—Ä–æ—Ü–µ—Å
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
let autoRefreshInterval;

document.addEventListener("DOMContentLoaded", function() {
    // –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è
    const autoRefreshCheckbox = document.getElementById("auto-refresh");
    if (autoRefreshCheckbox.checked) {
        startAutoRefresh();
    }
    
    autoRefreshCheckbox.addEventListener("change", function() {
        if (this.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });
    
    // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
    document.addEventListener("click", function(e) {
        if (e.target.classList.contains("start-process-btn")) {
            startForcedProcess(e.target.dataset.processType);
        } else if (e.target.classList.contains("stop-process-btn")) {
            stopForcedProcess();
        }
    });
});

function startAutoRefresh() {
    autoRefreshInterval = setInterval(refreshStatus, 5000);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

function refreshStatus() {
    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—ñ–≤
    fetch("/api/process-status/")
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateProcessesDisplay(data.processes, data.is_any_forced);
            } else {
                showMessage("error", "–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: " + data.error);
            }
        })
        .catch(error => {
            showMessage("error", "–ü–æ–º–∏–ª–∫–∞ –∑\"—î–¥–Ω–∞–Ω–Ω—è: " + error.message);
        });
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è
    refreshExtractionDetails();
}

function updateProcessesDisplay(processes, isAnyForced) {
    processes.forEach(process => {
        const card = document.querySelector(`[data-process-id="${process.id}"]`);
        if (card) {
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å
            const statusBadge = card.querySelector(".status-badge");
            statusBadge.className = `status-badge status-${process.status}`;
            statusBadge.textContent = process.status_display + (process.is_forced ? "‚ö°" : "");
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å
            const progressInfo = card.querySelector(".info-value");
            if (progressInfo) {
                let progressText = `${process.progress_current} / ${process.progress_total}`;
                if (process.progress_total > 0) {
                    progressText += ` (${process.progress_percentage.toFixed(1)}%)`;
                }
                progressInfo.textContent = progressText;
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä
            const progressFill = card.querySelector(".progress-fill");
            if (progressFill) {
                progressFill.style.width = process.progress_percentage + "%";
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –æ—Å—Ç–∞–Ω–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            const lastMessage = card.querySelector(".last-message");
            if (process.last_message) {
                if (lastMessage) {
                    lastMessage.innerHTML = "üìù " + process.last_message;
                } else {
                    // –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —è–∫—â–æ –π–æ–≥–æ –Ω–µ –±—É–ª–æ
                    const messageDiv = document.createElement("div");
                    messageDiv.className = "last-message";
                    messageDiv.innerHTML = "üìù " + process.last_message;
                    card.querySelector(".process-content").appendChild(messageDiv);
                }
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫–∏
            const startBtn = card.querySelector(".start-process-btn");
            const stopBtn = card.querySelector(".stop-process-btn");
            
            if (startBtn) {
                startBtn.disabled = isAnyForced;
            }
            
            if (process.is_forced && !stopBtn) {
                // –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É –∑—É–ø–∏–Ω–∫–∏
                const actionsDiv = card.querySelector(".process-actions");
                const stopButton = document.createElement("button");
                stopButton.className = "btn btn-danger stop-process-btn";
                stopButton.innerHTML = "‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏ –ø—Ä–∏–º—É—Å–æ–≤–∏–π –ø—Ä–æ—Ü–µ—Å";
                actionsDiv.appendChild(stopButton);
            } else if (!process.is_forced && stopBtn) {
                // –í–∏–¥–∞–ª—è—î–º–æ –∫–Ω–æ–ø–∫—É –∑—É–ø–∏–Ω–∫–∏
                stopBtn.remove();
            }
        }
    });
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º–∏
    updateSystemStatus(isAnyForced);
}

function updateSystemStatus(isAnyForced) {
    const banner = document.querySelector(".forced-process-banner");
    const systemStatus = document.querySelector(".system-status");
    
    if (isAnyForced && !banner) {
        // –î–æ–¥–∞—î–º–æ –±–∞–Ω–µ—Ä —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î
        const bannerDiv = document.createElement("div");
        bannerDiv.className = "forced-process-banner";
        bannerDiv.innerHTML = "‚ö° –£–í–ê–ì–ê: –ê–∫—Ç–∏–≤–Ω–∏–π –ø—Ä–∏–º—É—Å–æ–≤–∏–π –ø—Ä–æ—Ü–µ—Å<br>–í—Å—ñ —ñ–Ω—à—ñ –ø—Ä–æ—Ü–µ—Å–∏ –ø—Ä–∏–∑—É–ø–∏–Ω–µ–Ω—ñ";
        systemStatus.parentNode.insertBefore(bannerDiv, systemStatus);
        systemStatus.style.display = "none";
    } else if (!isAnyForced && banner) {
        // –í–∏–¥–∞–ª—è—î–º–æ –±–∞–Ω–µ—Ä
        banner.remove();
        systemStatus.style.display = "block";
    }
}

function startForcedProcess(processType) {
    const formData = new FormData();
    formData.append("process_type", processType);
    formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");
    
    fetch("/api/start-forced-process/", {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage("success", data.message);
            refreshStatus();
        } else {
            showMessage("error", data.error);
        }
    })
    .catch(error => {
        showMessage("error", "–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É: " + error.message);
    });
}

function stopForcedProcess() {
    const formData = new FormData();
    formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");
    
    fetch("/api/stop-forced-process/", {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage("success", data.message);
            refreshStatus();
        } else {
            showMessage("error", data.error);
        }
    })
    .catch(error => {
        showMessage("error", "–ü–æ–º–∏–ª–∫–∞ –∑—É–ø–∏–Ω–∫–∏: " + error.message);
    });
}

function startIncrementalExtraction() {
    showMessage("info", "–ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–µ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è —Ä–µ–∑–æ–ª—é—Ç–∏–≤–Ω–∏—Ö —á–∞—Å—Ç–∏–Ω...");
    
    fetch("/api/start-incremental-extraction/", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            "missing_only": true,
            "auto_incremental": true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage("success", "–Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–µ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ");
            refreshStatus();
        } else {
            showMessage("error", data.error || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è");
        }
    })
    .catch(error => {
        showMessage("error", "–ü–æ–º–∏–ª–∫–∞: " + error.message);
    });
}

function startSmallBatchExtraction() {
    showMessage("info", "–ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —Ç–µ—Å—Ç–æ–≤–µ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è 10 —Ä—ñ—à–µ–Ω—å...");
    
    fetch("/api/start-small-batch-extraction/", {
        method: "POST", 
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            "limit": 10,
            "missing_only": true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage("success", "–¢–µ—Å—Ç–æ–≤–µ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ");
            refreshStatus();
        } else {
            showMessage("error", data.error || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è");
        }
    })
    .catch(error => {
        showMessage("error", "–ü–æ–º–∏–ª–∫–∞: " + error.message);
    });
}

function startUltraFastExtraction() {
    // –ó–∞–ø–∏—Ç—É—î–º–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –¥–ª—è —É–ª—å—Ç—Ä–∞-—Ä–µ–∂–∏–º—É
    if (!confirm("üöÄ –£–í–ê–ì–ê: –ó–∞–ø—É—Å–∫ –£–õ–¨–¢–†–ê-–®–í–ò–î–ö–û–ì–û –†–ï–ñ–ò–ú–£!\n\n" +
                 "‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä–∏:\n" +
                 "- 200 –ø–æ—Ç–æ–∫—ñ–≤ –æ–¥–Ω–æ—á–∞—Å–Ω–æ\n" + 
                 "- –ë–ï–ó –õ–Ü–ú–Ü–¢–£ (–í–°–Ü —Ä—ñ—à–µ–Ω–Ω—è)\n" +
                 "- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å\n\n" +
                 "‚ö†Ô∏è –¶–µ –º–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≤–∏—Å–æ–∫–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ —Å–∏—Å—Ç–µ–º—É.\n\n" +
                 "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?")) {
        return;
    }
    
    showMessage("info", "üöÄ –ó–ê–ü–£–°–ö–ê–Ñ–¢–¨–°–Ø –£–õ–¨–¢–†–ê-–®–í–ò–î–ö–ò–ô –†–ï–ñ–ò–ú...\n200 –ø–æ—Ç–æ–∫—ñ–≤, –í–°–Ü —Ä—ñ—à–µ–Ω–Ω—è –ë–ï–ó –ª—ñ–º—ñ—Ç—É!");
    
    fetch("/api/start-ultra-fast-extraction/", {
        method: "POST", 
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            "ultra_mode": true,
            "limit": 0,  // 0 = –ë–ï–ó –ª—ñ–º—ñ—Ç—É, –æ–±—Ä–æ–±–ª—è—Ç–∏ –í–°–Ü —Ä—ñ—à–µ–Ω–Ω—è
            "missing_only": true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage("success", "üöÄ –£–õ–¨–¢–†–ê-–®–í–ò–î–ö–ò–ô –†–ï–ñ–ò–ú –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!\n–û—á—ñ–∫—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤...");
            refreshStatus();
        } else {
            showMessage("error", data.error || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É —É–ª—å—Ç—Ä–∞-—à–≤–∏–¥–∫–æ–≥–æ —Ä–µ–∂–∏–º—É");
        }
    })
    .catch(error => {
        showMessage("error", "–ü–æ–º–∏–ª–∫–∞: " + error.message);
    });
}

function refreshExtractionDetails() {
    fetch("/api/extraction-stats/")
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateExtractionDetails(data.stats);
            } else {
                showMessage("error", "–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è: " + data.error);
            }
        })
        .catch(error => {
            showMessage("error", "–ü–æ–º–∏–ª–∫–∞ –∑\"—î–¥–Ω–∞–Ω–Ω—è: " + error.message);
        });
}

function updateExtractionDetails(stats) {
    // –û–Ω–æ–≤–ª—é—î–º–æ –µ—Ç–∞–ø–∏ –æ–±—Ä–æ–±–∫–∏
    const stagesElement = document.getElementById("extraction-stages");
    if (stagesElement) {
        stagesElement.innerHTML = `
            üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${stats.decisions_with_rtf} —Ä—ñ—à–µ–Ω—å<br>
            üîç –ê–Ω–∞–ª—ñ–∑: ${stats.decisions_with_resolutions} –æ–±—Ä–æ–±–ª–µ–Ω–∏—Ö<br>
            ‚úÖ –¢—Ä–∏–≥–µ—Ä-—Å–ª–æ–≤–∞: ${stats.decisions_with_triggers} –∑–Ω–∞–π–¥–µ–Ω–æ<br>
            ‚è≥ –ó–∞–ª–∏—à–∏–ª–æ—Å—å: ${stats.decisions_without_resolutions} —Ä—ñ—à–µ–Ω—å
        `;
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
    const efficiencyElement = document.getElementById("extraction-efficiency");
    if (efficiencyElement) {
        efficiencyElement.innerHTML = `
            üìà –ü—Ä–æ–≥—Ä–µ—Å: ${stats.extraction_percentage}%<br>
            üéØ –¢—Ä–∏–≥–µ—Ä-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω—ñ—Å—Ç—å: ${stats.trigger_percentage}%<br>
            üíæ RTF –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å: ${stats.rtf_availability_percentage}%<br>
            ‚ö° –®–≤–∏–¥–∫—ñ—Å—Ç—å: ${stats.extraction_speed_24h} —Ä—ñ—à–µ–Ω—å/24–≥
        `;
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–Ω–¥–µ–Ω—Ü—ñ—ó
    const trendsElement = document.getElementById("extraction-trends");
    if (trendsElement) {
        const trendIcon = stats.week_trend > 0 ? "üìà" : stats.week_trend < 0 ? "üìâ" : "üìä";
        trendsElement.innerHTML = `
            üìÖ –ó–∞ —Å—å–æ–≥–æ–¥–Ω—ñ: ${stats.today_extractions} —Ä—ñ—à–µ–Ω—å<br>
            üìä –ó–∞ —Ç–∏–∂–¥–µ–Ω—å: ${stats.week_extractions} —Ä—ñ—à–µ–Ω—å<br>
            üìà –ó–∞ –º—ñ—Å—è—Ü—å: ${stats.month_extractions} —Ä—ñ—à–µ–Ω—å<br>
            üî• –ü—ñ–∫–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å: ${stats.peak_extraction_hour}:00<br>
            ${trendIcon} –¢–∏–∂–Ω–µ–≤–∞ —Ç–µ–Ω–¥–µ–Ω—Ü—ñ—è: ${stats.week_trend > 0 ? "+" : ""}${stats.week_trend}%
        `;
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —è–∫—ñ—Å—Ç—å –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è
    const qualityElement = document.getElementById("extraction-quality");
    if (qualityElement) {
        qualityElement.innerHTML = `
            ‚úÖ –£—Å–ø—ñ—à–Ω—ñ: ${stats.successful_extractions} —Ä—ñ—à–µ–Ω—å<br>
            ‚ùå –ü–æ–º–∏–ª–∫–∏: ${stats.failed_extractions} —Ä—ñ—à–µ–Ω—å<br>
            üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞ –æ–±—Ä–æ–±–∫–∞: 0 —Ä—ñ—à–µ–Ω—å<br>
            üìè –°–µ—Ä–µ–¥–Ω—è –¥–æ–≤–∂–∏–Ω–∞: ${stats.avg_resolution_length} —Å–∏–º–≤–æ–ª—ñ–≤
        `;
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä
    const progressFill = document.querySelector("#extraction-details .progress-fill");
    if (progressFill) {
        progressFill.style.width = stats.extraction_percentage + "%";
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–µ—Å—É
    const progressText = document.querySelector("#extraction-details + div");
    if (progressText) {
        progressText.textContent = `–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è: ${stats.extraction_percentage}%`;
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –≥—Ä–∞—Ñ—ñ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
    updateActivityChart(stats.activity_chart_data, stats.last_24h_extractions);
}

function updateActivityChart(chartData, totalExtractions) {
    const chartElement = document.getElementById("extraction-activity-chart");
    if (chartElement) {
        // –°—Ç–≤–æ—Ä—é—î–º–æ –ø—Ä–æ—Å—Ç–∏–π —Ç–µ–∫—Å—Ç–æ–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫
        let chartHtml = "";
        const maxCount = Math.max(...chartData.map(d => d.count));
        
        if (maxCount > 0) {
            chartHtml = "<div style="display: flex; align-items: end; height: 100%; gap: 1px; padding: 5px;">";
            chartData.forEach(data => {
                const height = maxCount > 0 ? (data.count / maxCount * 50) : 0;
                const opacity = data.count > 0 ? 0.7 : 0.3;
                chartHtml += `<div style="flex: 1; background: rgba(33, 150, 243, ${opacity}); height: ${height}px; min-height: 2px; border-radius: 1px;" title="${data.hour}:00 - ${data.count} –≤–∏—Ç—è–≥—É–≤–∞–Ω—å"></div>`;
            });
            chartHtml += "</div>";
        } else {
            chartHtml = "<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; font-size: 12px;">üìä –ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –∑–∞ 24 –≥–æ–¥–∏–Ω–∏</div>";
        }
        
        chartElement.innerHTML = chartHtml;
    }
}

function showMessage(type, message) {
    const container = document.getElementById("message-container");
    const alertDiv = document.createElement("div");
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    
    container.innerHTML = "";
    container.appendChild(alertDiv);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}